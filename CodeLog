Test 7 isn't consistent.
=-=2 - Fri Dec  4 18:17:19 PST 2009

Toy examples done. url -> related docs.
Data structures now starting to take shape.

Tests are ugly, code interleaved with data.
We can use more indexes.
Decouple the index like in SQL, so the same code runs faster if the index
exists.
=-=4 - Fri Dec  4 19:14:31 PST 2009

Finished building the index. gen-docs works.
=-=5 - Sat Dec  5 09:47:15 PST 2009
Added agg3 ui to it. Messy that I've added stations to the flat-history model.
  Form to create new station.
  Choose between stations, each station gets its own read-list.
=-=6 - Mon Dec  7 13:22:11 PST 2009

Importing agg3 crawl pipeline. Next step: merge properly.

Vision: crawl a universal set of feeds. Don't wait for entire crawl to import
crawled feeds. Track per-user feeds and feed priorities in userinfo*. Make
agg3 just another station for users who import feeds. Push station selection
to a new screen; add new station form to the left panel when reading. Track
history by station.

Later: screens to manage feeds. Stations for importing email, other data
sources, etc. Discovering new feeds during crawl.
=-=7 - Tue Dec  8 12:06:08 PST 2009

crawl and htmlclean now communicate by fifo.
But it's currently blocking. So htmlclean blocks until input, then just reads
the first input and goes back to waiting. Meanwhile if I add a delay to
htmlclean it blocks crawl instead.
=-=8 - Tue Dec  8 14:11:15 PST 2009
If we stick with the blocking model we need to start the pipeline in reverse
order, from consumer to producer of each fifo.

If any stage dies, all other stages will block.

Will we lose stuff in fifos if we kill arc? Periodically look at files under
urls/
=-=9 - Tue Dec  8 15:06:09 PST 2009
Redefine defscan to run in separate threads, not a single thread.
Also some reorg.
=-=10 - Tue Dec  8 18:16:09 PST 2009

3 Crawl errors fixed.
=-=11 - Tue Dec  8 19:34:06 PST 2009

Instead of printing progress for background threads, maintain a circular
buffer of messages for each.
Not persistent for now.
=-=12 - Tue Dec  8 22:34:02 PST 2009

Focusing on UI.
Yesterday's problem: we want to scan read-list for both gen-docs and rendering
history.
=-=14 - Tue Dec  8 22:48:22 PST 2009

Ok, partial matches now working. Takes too long, though. Do all the work in
one pass. Every page load should do just one pass through docinfo*.
=-=15 - Tue Dec  8 23:24:59 PST 2009
Single pass for site-docs and feed-docs takes test runtime down from 72s to
42s for 13650 items in docinfo. But it's still too much.
=-=16 - Tue Dec  8 23:54:18 PST 2009
All that time is being spent on downcase!
Just add downcase versions of all metadata.
Or cache downcase separately.
=-=17 - Wed Dec  9 00:00:57 PST 2009
Yep, cached downcase and got to within 3x of non-downcase version.
=-=18 - Wed Dec  9 00:04:45 PST 2009

Time to start indexing. It's working, but dies every now and then. I think
it's dying when the pipe breaks.
=-=19 - Wed Dec  9 00:35:19 PST 2009
Ok, found the core dump in keywords.cc - negative index.
=-=21 - Thu Dec 10 00:44:08 PST 2009
Cleanup.
=-=22 - Thu Dec 10 00:46:41 PST 2009

Back to the UI. Refactoring index.arc to always take a user arg.
gen-docs doesn't like docs as arguments. I need to test-drive this..
=-=23 - Fri Dec 11 04:55:14 PST 2009
Done. Rebuilding the index.
=-=24 - Fri Dec 11 08:10:24 PST 2009

Lots of reorg, getting tests to pass.
Framework for gen-docs:
  generate candidates using doc-filters* and misc-filters*
  constraints to filter candidates
  score remaining candidates
=-=27 - Fri Dec 11 22:41:22 PST 2009

Trying to redo transparent persistence.
  Avoid unnecessary writes based on palsecam's idea.
  Write to new files so we have backups, and to eliminate any chance of data loss.
Doesn't work yet. I just realized save-registry needs to store references to
variables, not names.
Which means if I assign to a persistent variable I will lose persistence on it.
=-=30 - Sun Dec 13 19:53:37 PST 2009
Ok, save-registry now indexes by reference. But still not working. What's
going on?

Two bugs:
  a) (hash key) searches by value, even if what is stored in the hash is a
  reference. What's more it's searching by value at the time of insertion.
  Weird.
  b) buffered-exec isn't wiping when it should.
=-=31 - Sun Dec 13 20:43:03 PST 2009
Ah, it's a *hash* table. It's storing by reference but the hash is computed by
value.
  http://arclanguage.org/item?id=10984
It just shouldn't store by reference. That makes it too confusing.

Got the new transparent persistence working.
=-=32 - Mon Dec 14 01:23:05 PST 2009
Bugfix: snapshots were never being loaded.
=-= - Mon Dec 14 11:30:12 PST 2009

Getting readwarp up on AWS.
After all that testing turns out I never tested the metadata scan. It was
emitting strings with quotes escaped. Fixed.
=-=33 - Wed Dec 16 01:30:36 PST 2009
More bugfixing.
=-=36 - Thu Dec 17 17:18:00 PST 2009
Compute affinity graph by feed rather than url.

But it was taking too long; dhash wasn't working right. Ah, I never did
implement the nilcache idea to avoid recomputation.
Bring back old state.arc tests as well.
=-=37 - Thu Dec 17 19:55:41 PST 2009
Still struggling to compute feed affinity graph.
It's too slow. Let's switch to shell pipes. Dev speed includes performance
when experiments are this intensive and iterations this frequent.
=-=39 - Fri Dec 18 21:21:02 PST 2009

New python script to try normalizing overlap by keyword between feeds - each
keyword distributes 1/n to n*n feed connections.
We're seeing some quality. Krugman's blog is kinda well-connected to financial
blogs or blogs with kinda financial content.

Next steps:
  a signal for article-article overlap to help get at financial posts within
  say larry cheng's feed
  improve html cleaning to remove spurious overlap

Let's see if we can get by without changing keywords algo.
=-=41 - Sat Dec 19 15:29:31 PST 2009

Focusing on html cleaning now. First step: workflow to add tests to a corpus.
=-=42 - Sun Dec 20 15:25:27 PST 2009
Test script up and running.
=-=46 - Sun Dec 20 19:42:33 PST 2009
Added failing test cases by searching for commonly-occurring sets of keywords.
Just make one test case from each such set, that gives us 53 failing tests.
Ok, we've now got our work cut out for us.
=-=49 - Mon Dec 21 01:01:44 PST 2009

I need to add hints from feed descriptions. Step 1: crawl feeds to save
descriptions.
=-=50 - Tue Dec 22 12:23:03 PST 2009
Step 2: use the deschint: if it exists return the highest-scoring node that
contains the hint as a substring.

Unicode errors; I'm going over this tutorial:
  http://docs.python.org/howto/unicode.html
=-=51 - Tue Dec 22 13:55:41 PST 2009
=-=52 - Tue Dec 22 20:16:06 PST 2009
Turns out sorting by score then searching for a superset of deschint isn't
working.
=-=53 - Wed Dec 23 00:12:14 PST 2009
Fixed. 12 more tests passing.
=-=54 - Wed Dec 23 00:28:47 PST 2009
Evaluating the html cleaning process. We have 4 kinds of errors:
  Fixating on common content, either subtitles or sidebar
  Picking a comment instead of the post, usually when there's lots of comments
    slashdot, etc.
  Picking too much
  Picking too little
We've been under-estimating how well deschint does because these failures
aren't in their feeds anymore. Let's manually add hints, then try it on live
data.
=-=57 - Wed Dec 23 12:50:21 PST 2009
Hints manually added; 23 more tests pass, 31 still failing.
=-=59 - Wed Dec 23 13:50:59 PST 2009
Focussing on tweets. Why is so little matching?
=-=60 - Wed Dec 23 14:18:07 PST 2009
difflib limitation. Switched to http://code.google.com/p/google-diff-match-patch
Now we're down to 10 failing tests, but with two caveats:
  a) The new code is *much* slower. 150 tests took 34 minutes, which used to
  take ~1-2 minutes.
  b) We're probably under-counting failures because too-loose failures no
  longer get detected.
=-=61 - Wed Dec 23 15:55:08 PST 2009
Simple dilution metric to identify failing tests. 0.6 seems like a reasonable
boundary, but we're gonna occasionally get it wrong.
It's only for identifying failing tests, though. Let's focus on making them
pass more unequivocally.
=-=62 - Wed Dec 23 16:26:47 PST 2009
=-=63 - Wed Dec 23 17:55:01 PST 2009
Debugged the dilution metric. 50 of yesterday's tests are now reclassified as
failing, but I'm finally certain I'm not over-counting.

This took too long. I'd introduced a bug in fuzzymatch, then spent all day
staring at fuzzycheck.
=-=65 - Thu Dec 24 11:30:08 PST 2009
Cleanup.
=-=66 - Thu Dec 24 12:02:12 PST 2009
4 regressions compared to rev 57.
=-=68 - Thu Dec 24 14:38:07 PST 2009
Lost momentum yday thinking diff-match-patch too had issues as a difflib.

After adding a couple of test cases today I realize the problem isn't the diff
algo, but beautifulSoup. When the html breaks it inserts close tags in the
wrong place.
=-=69 - Fri Dec 25 20:59:34 PST 2009
No, even the html parsing is fine. So how are we getting close tags in the
wrong place?
=-=70 - Fri Dec 25 21:09:51 PST 2009
Ah, it's the substitution of <br> pairs for <p>'s. Then the <p> within the
table confuses BeautifulSoup.
=-=71 - Fri Dec 25 21:16:42 PST 2009
  [Accidentally committed htmlclean.py@60. Back to 68.
  =-=72 - Fri Dec 25 21:25:12 PST 2009]
It's a simple fix! Replace with <p>, not </p><p>. The close tag causes grief.
=-=73 - Fri Dec 25 21:30:24 PST 2009
Ok, convinced myself I don't really have regressions, the new failures are
because of tighter checks.
=-=77 - Sat Dec 26 12:35:32 PST 2009
=-=79 - Sun Dec 27 10:33:47 PST 2009

Back to arc. Loose html cleaning is ok for now - we'll at least get the
content of the article. Getting the whole html is prob bad, but let's see how
far we get with what we have.

New ds: feed-list*
Resisting the urge to create a fun defrep macro.
=-=81 - Mon Dec 28 21:42:49 PST 2009
Clean out old implementation. Let's just get keyword->seed feed working for
starters. Typing in 'cnn' should show a story from cnn.com
=-=82 - Mon Dec 28 21:51:38 PST 2009

Update crawl to record some feed metadata.
No author, sadly.
=-=83 - Tue Dec 29 18:15:04 PST 2009
Ah, just save feed description.
=-=86 - Wed Dec 30 11:52:59 PST 2009
First cut of kwd->feed. Too slow.
=-=89 - Thu Dec 31 04:36:33 PST 2009
Indexing feedinfo now. kwd-feeds can now help locate seed feeds.
=-=90 - Fri Jan  1 18:15:12 PST 2010
kwd-feeds now done.
scan-doc-dir: Finding docs that aren't in docinfo.

Also some new utils.
Start creating data structures more willy-nilly. We're almost there. Build,
then refactor.
=-=91 - Sun Jan  3 20:08:08 PST 2010
scan-doc-dir ended up costing me a whole day.
When I work without deliberation I can make boneheaded decisions like this.
And now snapshots.docinfo takes over 15 minutes to load.
=-=92 - Mon Jan  4 11:26:01 PST 2010
feed-affinity graph: Translate feedgraph.py into arc.
=-=93 - Mon Jan  4 17:29:39 PST 2010
feed-affinity graph implemented, not yet operationalized so I don't know how
to incrementally update it.
Too many pieces of the pipeline are having trouble scaling. I need to figure
out why.
  Start gc'ing documents.
=-=95 - Mon Jan  4 23:49:30 PST 2010
Ok, we were out of disk, that explains the slow initialization.
feed-affinity graph is easy to incrementally update. After the initial run
start calling update-normalized-keyword-clusters for each feed as it rolls in.
=-=96 - Tue Jan  5 09:38:02 PST 2010
shadow macro: dynamic binding so I can run tests on index functions without
having the fixtures clobber my shite.
We'll still lose changes while the tests run, though.
=-=97 - Tue Jan  5 12:53:30 PST 2010
another helper: shadow all persistent variables.
=-=98 - Tue Jan  5 14:23:55 PST 2010
index.arc.t will now run properly without touching real indexes.
Its tests still fail though.
=-=99 - Tue Jan  5 14:34:50 PST 2010

Workspace. Test driving several primitives.
=-=102 - Tue Jan  5 18:27:31 PST 2010
Done test-driving propagate primitives. This shouldn't have been so hard.
=-=104 - Wed Jan  6 00:04:08 PST 2010
Playing around with propagate. Added reinforce to boost candidates without
creating new ones.
Several sources of error in updating feeds. Moving back to the backend.
=-=106 - Wed Jan  6 12:21:09 PST 2010
Some tune-up.
Spent too long rebuilding the data structures. Again, shouldn't have been so
hard.
=-=107 - Wed Jan  6 14:26:37 PST 2010
Ok, incremental updates to data structures now working.
=-=109 - Wed Jan  6 15:24:45 PST 2010
Putting all the pieces together. Propagate working, but we just keep
propagating docs to keywords. We need to pick some other items each time to
propagate to more docs.
=-=113 - Thu Jan  7 18:54:43 PST 2010
Workspace entries now know their age in iters. Iter = up-vote.
First-cut of prune.
Code is functional, passes all tests, responsive. We still never leave the
seed feeds.
=-=115 - Fri Jan  8 00:17:02 PST 2010
Add only unread docs to workspace.
=-=116 - Fri Jan  8 00:36:55 PST 2010
Propagate-to-doc working, we're starting to see new feeds gradually pop up.
=-=117 - Fri Jan  8 10:50:20 PST 2010
Diversity - no more consecutive stories from a feed.
=-=118 - Fri Jan  8 11:29:28 PST 2010
Some bugfixes as I move past my 'krugman' test case to a 'burrito justice'
station.
Time to get on the relatively fresh index at EC2.
=-=119 - Fri Jan  8 11:35:32 PST 2010

Super slow on EC2. Culprit: Scanning workspace for candidates. time:keep needs
to be speeded up.
=-=122 - Sat Jan  9 15:08:14 PST 2010
After considering trees and priority queues, settled on a skiplist data
structure for fast top-n and search/insert/delete operations. Starting to
build one in arc.
=-=125 - Sun Jan 10 01:13:06 PST 2010
More elegant skip list phrasing. Onward.
=-=126 - Sun Jan 10 12:24:41 PST 2010

Intermittent bug.
current stack:
  random-level not getting overridden
  isolate reproducibly failing test
  was insert working before introducing scan?
  fix insert regression after introducing scan
  refactor out fit-into

Ack, scoped-extend will need more work. I need to save the value and yet
shadow. Ignore it for now.
=-=127 - Sun Jan 10 12:55:08 PST 2010
test fails when we insert at height 0.
=-=128 - Sun Jan 10 13:09:04 PST 2010
Ack, weird typos. Fixed with some divide and conquer from rev 125 onward.
One drawback of loop: the three cases are hard to see and if there's a fourth
like here you can run around chasing your tail.
=-=130 - Sun Jan 10 13:40:26 PST 2010
Better indentation can help.
=-=131 - Sun Jan 10 13:41:28 PST 2010
Cleanup. Back to refactoring fit-into.
=-=132 - Sun Jan 10 13:52:01 PST 2010
scoped-extend fixed!
=-=133 - Sun Jan 10 14:07:21 PST 2010
Updated skip list test to use scoped-extend.
=-=134 - Sun Jan 10 14:21:39 PST 2010
Cleanup.
=-=135 - Sun Jan 10 14:30:05 PST 2010
Wow, how was it working? base-0 indexing, base-1 indexing, it was a mess.
Anyway, find almost done. Final test still failing.
=-=136 - Sun Jan 10 16:04:09 PST 2010
Whoa, and it's again non-deterministic.
=-=137 - Sun Jan 10 16:05:21 PST 2010
Agh, random-level sometimes returns nil.
This was really hard to debug until I just started staring at its output.
Combination of non-manifestation for short runs + non-determinism at 500-iter
run + not being able to print out nodes.
=-=138 - Sun Jan 10 16:36:08 PST 2010
False alarm: I'd confused myself in trying to create a track for random-level.
The real bug was one last vestige (hopefully) of base-0/base-1 confusion.
=-=139 - Sun Jan 10 16:54:46 PST 2010
Cleanup.
=-=140 - Sun Jan 10 17:10:07 PST 2010
redef macro to disable redefinition warnings.
=-=141 - Sun Jan 10 17:16:55 PST 2010
looplet -> letloop. Better indicates that loop is within a new scope rather
than vice versa. Also avoids association with piglet, etc.
=-=142 - Sun Jan 10 17:21:56 PST 2010
Use redef in before/after-exec.
=-=143 - Sun Jan 10 17:28:29 PST 2010
Performance test done, skip list is working fine. Disabled by default since
it's interactive.
I have a version to pick random numbers, but it won't be very
well-distributed.
=-=145 - Sun Jan 10 18:52:57 PST 2010
Ok, I can enable it if I create a more dense list.
=-=146 - Sun Jan 10 18:58:50 PST 2010

Starting on transformer function for skip lists.
=-=148 - Sun Jan 10 19:22:03 PST 2010
First test of insert and find now working.
Code's looking ugly now, especially the var nv in find-sl.
=-=149 - Sun Jan 10 19:35:33 PST 2010
Hmm, another set of tests seem to show all in order.
=-=150 - Sun Jan 10 23:12:10 PST 2010
Cleanup.
=-=151 - Sun Jan 10 23:15:33 PST 2010
Delete.
One failing test case: can't find multiple entries with identical transformer
functions. Not an issue before we added transformer functions.
=-=152 - Mon Jan 11 00:23:49 PST 2010
Fixed.
Entire final page of skiplist methods is now super-ugly. find, delete, scan2.
=-=153 - Mon Jan 11 00:36:48 PST 2010
Mon Jan 11 00:49:38 PST 2010
Still one issues to be ironed out in skip lists: when to wade sequentially
through entries transforming to the same metric. I run into an infinite loop
every so often, even though there's now 5 conditions on it.
Mon Jan 11 11:04:43 PST 2010
Scanning ahead on level 0 violates a pre-condition: that in scan2(sl nd v l)
nd!next has at least l+1 elements. Scanning ahead by 1 can leave you with an
element of shorter height.
We shouldn't be doing this except after the final scan.
=-=154 - Mon Jan 11 11:06:46 PST 2010
Intermediate cleanup. New test cases coming up.
=-=155 - Mon Jan 11 11:31:24 PST 2010
New fixture, and a couple of tests with it. Already the code looks cleaner.
=-=156 - Mon Jan 11 12:28:53 PST 2010
Other tests easily pass.
=-=157 - Mon Jan 11 12:40:51 PST 2010
Cleanup. Zoomed back out to the whole project. All tests pass.
=-=158 - Mon Jan 11 12:58:15 PST 2010

Trying briefly to make the new-snapshot-name test more consistent.
But for some reason ,(seconds) doesn't get over-ridden.
=-=159 - Mon Jan 11 13:43:40 PST 2010
It's because anytime you invoke new-snapshot-name from a function, it gets
macro-expanded in place.
Let's just get rid of that test, it's not worth the trouble.
=-=160 - Mon Jan 11 13:47:31 PST 2010

Ok, start using skip lists in workspace. Pre-cleanup.
=-=161 - Mon Jan 11 14:17:41 PST 2010
Integrated into workspace; now propagate seems slow, with all those
insert-sl's.
=-=163 - Mon Jan 11 18:12:15 PST 2010
If I hit C-c while tests are running I get a "could not shadow" message with
a humongous, uninterruptable printout of the large data structures. Fixed.
=-=165 - Mon Jan 11 21:27:59 PST 2010
index tests passing. But I need to turn off defrep's to avoid interfering with
tests. Still holding out before using aw's proper dynamic variables.
=-=166 - Mon Jan 11 22:08:00 PST 2010
Ah, insert-sl is inefficient! Each level starts from the start of the list, so
the lowest level is always treating it as a plain list.
Hopefully this is the reason propagate is slow.
=-=168 - Mon Jan 11 22:40:12 PST 2010
Fixed.
=-=169 - Mon Jan 11 22:41:07 PST 2010

New bug: app suddenly seizes up inside insert-sl every so often.
It's not GC. It really is where the prints say it is (the artificial stack
trace confirms it's always stalled in f1 or f2). And once it gets there any
assignment stalls it, not writes to node!next. An issue with atomic?
=-=170 - Tue Jan 12 10:45:25 PST 2010
We're definitely not running out of thread-cells or semaphores since only one
of each is ever created (instrumented arc).
=-=171 - Tue Jan 12 11:24:17 PST 2010
Ah, a glimmer. Things work when we stop modifying sref to autosave.
=-=172 - Tue Jan 12 12:03:54 PST 2010
It's not an infinite loop in trying to buffered-exec. In fact we never even
trigger buffered-exec.
It's not really happening with the modified sref, or at least not as far as I
can see.
=-=173 - Tue Jan 12 12:19:07 PST 2010
And yet, if we disable buffered-exec entirely the problem goes away.
=-=174 - Tue Jan 12 12:20:36 PST 2010
Waiting for atomic's semaphore with the other thread?
=-=175 - Tue Jan 12 12:23:03 PST 2010
Argh, it's dying when the first buffered-exec triggers, so we can't currently
run for longer than 10s!
=-=176 - Tue Jan 12 12:25:59 PST 2010
Ok, we're unable to write userinfo*. Nothing to do with skiplists or index at
all.
=-=177 - Tue Jan 12 12:28:26 PST 2010
Cleanup. Of course we won't be able to write userinfo* now what we have all
these pointers all over the place. I should have realized when I deleted all
those userinfo*.*.tmp files a couple of hours ago.
=-=178 - Tue Jan 12 12:39:07 PST 2010
Just ignore saving userinfo* for now. For the demos this week let's just show
a stateless version. Now focus on speed, in the UI and in the crawl/clean
pipeline.
=-=179 - Tue Jan 12 15:05:50 PST 2010

Ok, benchmarking is now up. Bottleneck now propagate, not next-doc. So far, so
good.
=-=180 - Tue Jan 12 16:06:42 PST 2010
Memoizing metric in skiplist gives us 3-3.5x speedup. First propagate now
takes 20s rather than 70s. Still too long.
=-=182 - Tue Jan 12 17:17:53 PST 2010
We're doing 760k skiplist traversals in 1350 propagates. 15ms/prop, 38
travs/ms.
=-=183 - Tue Jan 12 17:53:30 PST 2010
Is the problem that next pointers are in a list? Preliminary experiments
indicate that random access in lists of size 30 is as cheap as in a table. By
the time the list grows to 750 elements there's a factor of 5 difference.
=-=184 - Tue Jan 12 18:05:49 PST 2010
Confirmed that the inner loop is scan (and not scan-handling-ties). 20s out of
25 are spent within it.
=-=185 - Tue Jan 12 18:12:03 PST 2010

First few iterations on laptop:
  == A
  time: 2 msec.
  "marking read " "http___krugman_blogs_nytimes_com_2009_11_09_finance_mythbusting_third_world_edition_" 
  propagating from http___krugman_blogs_nytimes_com_2009_11_09_finance_mythbusting_third_world_edition_ 25
  after prop: 808
  time: 7445 msec.
  99632 travs in 820 propagates
  == B
  time: 10 msec.
  "marking read " "http___yelnick_typepad_com_technik_2005_03_venture_overhan_html" 
  propagating from http___yelnick_typepad_com_technik_2005_03_venture_overhan_html 808
  after prop: 1945
  time: 27867 msec.
  745141 travs in 1349 propagates
  == C
  time: 1 msec.
  "marking read " "http___karthik82_com__page_doom_mode_reviews_id_12" 
  propagating from http___karthik82_com__page_doom_mode_reviews_id_12 1945
  after prop: 2171
  time: 34380 msec.
  == D
  time: 1 msec.
  "marking read " "http___yelnick_typepad_com_technik_2003_09_microsoft_blaze_html" 
  propagating from http___yelnick_typepad_com_technik_2003_09_microsoft_blaze_html 2148
  after prop: 2478
  time: 14625 msec.
  == E
  time: 15 msec.
  "marking read " "http___bnoopy_typepad_com_bnoopy_2004_10_moons_over_my_h_html" 
  propagating from http___bnoopy_typepad_com_bnoopy_2004_10_moons_over_my_h_html 1837
  after prop: 3532
  time: 95589 msec.

On EC2, propagating from 253 nodes, iter B takes over 10 minutes.
=-=190 - Wed Jan 13 11:49:47 PST 2010
Without doc-keywords-docs it's blazing.
=-=191 - Wed Jan 13 12:28:41 PST 2010
Evaluation before showing H&F meetup. Major issues:
1. It's still slow. timeout-exec isn't useable; fails to relinquish atomic
2. It's often ping-ponging between two feeds
  a) Downvotes don't penalize feed
  b) feed-affinity* graph only contains 99 feeds out of 1500
=-=194 - Wed Jan 13 17:28:11 PST 2010

Updating utils after code review:
  http://arclanguage.org/item?id=11129
In particular, it's useful that the way arc does destructuring eliminates the
major use case for zipmax.
=-=195 - Thu Jan 14 00:03:18 PST 2010

After fixing the kill-thread bug in arc, timeout-exec is working well.
Still kinda sluggish; we're seeing times of upto 30s, but this should suffice.
=-=197 - Thu Jan 14 13:27:09 PST 2010

Now focus on htmlclean. First step: revert to difflib. Suddenly it's much
faster. 33 failed test cases, but I'm now not convinced we're detecting
failures correctly.
=-=199 - Thu Jan 14 21:34:24 PST 2010
If we don't have faith in the metric, let's at least fall back to a metric we
do have faith in.
=-=200 - Thu Jan 14 21:41:50 PST 2010
Deleting pass 2. 4 more failures, but 4 extra certain successes, and tests
take 25% less time to run. So much for that.
=-=201 - Thu Jan 14 22:08:17 PST 2010
Degrade gracefully to just the feed description when you can't find a
candidate.
Why do I still have failing tests. Agh, let's try it out for reals.
=-=202 - Thu Jan 14 22:19:58 PST 2010
Don't show empty descriptions.
=-=203 - Thu Jan 14 22:38:56 PST 2010
Fresh urls. Cleanup.
=-=204 - Thu Jan 14 22:54:42 PST 2010

Back to front-end while the crawl runs.
Seth Cohen's suggestion yday: show story date.
=-=205 - Thu Jan 14 23:17:46 PST 2010
UI: new buttons with tool tips. Hooked up to nothing yet.
=-=206 - Fri Jan 15 00:25:29 PST 2010
Star for feed done.

- from plan
Preferred feeds ds by station. table: feed -> (manual weight (0-n), inferred weight (-1 to 1))
Showlist ds: Construct 5 stories at a time
Populating showlist
  Choose 1 lit doc in worklist
  Choose most recent story from upto 4 separate preferred feeds, avoiding the last 5
  Fill remainder with most recent story from random feeds by affinity, avoiding last 5
  Fill remainder with most recent story from random feeds, avoiding last 5 and unpreferred feeds
  Fill remainder with most recent story from random unpreferred feeds, avoiding last 5
  Fill remainder with most recent story from random feeds

mark-read: outcome 1-4
  4: preferred feed, propagate doc
  3: preferred feed after 5 3s, propagate doc
  2: do nothing
  1:
     manually preferred feed: disable prefer after 5 1s
     preferred feed: disable after 2 1s
     not preferred: unprefer
=-=207 - Fri Jan 15 14:07:21 PST 2010
Step 1: showlist data structure
=-=208 - Fri Jan 15 14:52:48 PST 2010
Step 2: preferred feeds, make it a table of properties rather than a simple
list
=-=209 - Fri Jan 15 15:55:55 PST 2010
mark-read => preferred feeds
=-=211 - Fri Jan 15 18:08:24 PST 2010

History icons fixed.
Clicking on things in the history brings them forward in this session, but not
in a persistent way. That seems reasonable.
=-=212 - Fri Jan 15 18:22:39 PST 2010

Populating showlist.
No change in behavior yet, but new structure is in place.
=-=213 - Fri Jan 15 18:47:57 PST 2010
Cranked it all out in one fell swoop. Not test-driven, not much testing. Now
let's play with it. 3 more hours before bed and tomorrow's reverse job fair.
=-=214 - Fri Jan 15 20:30:53 PST 2010
Unpreferred feeds weren't going away. Fixed.
3 other obvious issues:
1 feed affinity graph is broken. can't fix today. hopefully the new crawl will
  make it better.
2 scanning by affinity inserts dup feeds
3 new batch doesn't dedup against previous batch of 5
=-=215 - Fri Jan 15 20:47:45 PST 2010

Ack, shoulda enabled feed-affinity computations before restarting the crawl
yday.
=-=216 - Fri Jan 15 20:52:35 PST 2010

Issue 2 fixed. No more dups within a batch.
=-=217 - Fri Jan 15 20:56:13 PST 2010
Issue 3 fixed.
=-=218 - Fri Jan 15 21:12:11 PST 2010
Cleanup.
=-=219 - Fri Jan 15 21:15:06 PST 2010

Reset userinfo from online.
=-=222 - Sat Jan 16 07:45:56 PST 2010
Boundary condition: make the first story relevant and non-random if possible.
=-=223 - Sat Jan 16 07:48:17 PST 2010
New pass: pick feeds from the same group. Things looking much better.
Ok, work on speeding up EC2 now.
=-=225 - Sat Jan 16 08:17:10 PST 2010

mzscheme seems more finicky about load order on EC2. Fixed.
=-=226 - Sat Jan 16 08:40:47 PST 2010

Don't wait to the end of crawl to emit feedinfo.
=-=229 - Sat Jan 16 09:13:50 PST 2010

Logo idea after shdh.
=-=232 - Sat Jan 16 17:02:27 PST 2010
Front-page copy.
=-=233 - Sat Jan 16 17:12:42 PST 2010

Better feedinfo handling: save intermediate files, but don't delete the full
file until you have a complete replacement. In arc, gracefully read the best
version you can find.
=-=234 - Sat Jan 16 20:02:37 PST 2010

Logo: specify helvetica
Tried italic, that's pretty decent as well.
=-=235 - Sun Jan 17 19:51:24 PST 2010

A couple of bugfixes in update-feeds. We should now never lack for a story to
display, no matter how crappy.
=-=239 - Mon Jan 18 14:36:43 PST 2010

Bug in wait. I wasn't waiting for feed data structures to get initialized, and
that was messing things up.
But initializing data structures was taking forever in the presence of other
threads. The hypothesis was that multiple threads were thrashing on the atomic
semaphore. But even with that hypothesis the problem seemed insoluble..

Until I enclosed the function in an atomic. That's the second time (after
commit 197) that trick has bailed me out.
=-=241 - Tue Jan 19 20:33:31 PST 2010
Another atomic in the UI.
We're still seeing some timeouts, but not nearly so much. Inter-story delay is
pretty significant (10s of seconds). I'm freezing instrumentation to help
track why the timeout happens.
=-=244 - Tue Jan 19 21:53:53 PST 2010

Reloading index.arc was killing the repl.
=-=245 - Tue Jan 19 22:45:42 PST 2010

Try to ensure the first story on a station doesn't surprise the user.
=-=246 - Tue Jan 19 23:09:17 PST 2010

Trying to support partial urls, like cnn when the desc contains only cnn.com.
Or news.ycombinator.
=-=247 - Wed Jan 20 01:56:05 PST 2010
Fixed. Only include url in split-urls inside feed-keyword, not always.
=-=248 - Wed Jan 20 02:03:52 PST 2010

More tweaks to atomic: we only want the first iteration of defrep to be atomic
when the main thread may be waiting on it.
=-=249 - Wed Jan 20 12:38:23 PST 2010

For now let's just eliminate all our hacky atomics, disable the indexing
thread, and stabilize things on ec2 production.
Then I'm going to start investigating performance more thoroughly with
vector-set-performance-stats! (http://arclanguage.org/item?id=11177)
=-=250 - Thu Jan 21 10:10:38 PST 2010
doc-affinity takes forever to build. Ordering update-feeds ahead of it.
Still takes forever to get to a prompt. Disabling doc-affinity.
mzscheme keeps segfaulting now. Giving up, undo commit 249.
=-=251 - Thu Jan 21 11:30:55 PST 2010

Ah, the number of thread switches in UI thread goes up by 8x from 200 to 1600
when I enable the back-end. And it's all because of computations to update
feed-affinity, which I haven't really been using anyway. And doc-affinity we
already know isn't even every full computed.
Get rid of all that over-engineered cruft and the server is now looking very
promising.
=-=254 - Thu Jan 21 15:28:20 PST 2010

Suddenly save-snapshot isn't working.
=-=255 - Thu Jan 21 16:25:12 PST 2010
Bugfix to fwritefile: sometimes the file isn't available on the file system
before we try to rename it.
=-=256 - Thu Jan 21 18:13:34 PST 2010

Bringing back commit 249, defrep is now as it should be.
=-=257 - Thu Jan 21 18:26:02 PST 2010
Cleanup. Tests green again.
=-=258 - Thu Jan 21 18:35:20 PST 2010
Still more cleanup. All calls to keywords now gone.
=-=259 - Thu Jan 21 18:57:39 PST 2010

htmlclean: if the outermost node is a td, make it a div. Interferes with our
rendering.
=-=261 - Fri Jan 22 00:54:36 PST 2010

More cleanup, some refactoring.
=-=264 - Sat Jan 23 13:10:17 PST 2010

Monitoring logs, step 1: queries people type in.
=-=265 - Sat Jan 23 18:59:20 PST 2010

Done importing sites. blogs some other day.
When I build feed discovery I'm going to put requested feeds in a cordoned off
area until they're activated by somebody explicitly asking for them.
=-=266 - Sat Jan 23 19:59:05 PST 2010

New refactoring: inittab.
But I need it to evaluate keys as well.
=-=272 - Sun Jan 24 11:02:32 PST 2010
The obvious way doesn't work - just make it (table eval.k):
  Error: "reference to undefined identifier: _k"
  arc> (with (a nil x 3) (macex1 '(inittab a x (+ 3 1))))
  (do (or= a (table)) (each (k v) (pair (quote (x (+ 3 1)))) (or= (a eval.k) eval.v)) a)
  arc> (let x 3 (eval 'x))
  Error: "reference to undefined identifier: _x"
Should eval recognize let bindings? It doesn't work in mzscheme either.

In any case, there is a solution: draw a fresh boundary between function and
macro to enable evaluation.
Inspired by fill-table after reading http://arclanguage.org/item?id=456
via* arcforum searchyc: obj
But it's not perfect. If I want init-table to take an explicit second list arg
like fill-table I don't know how to keep inittab working.
I see what Alan Kay meant now; it feels kinda hackish to influence evaluation
by function boundary, use of @, etc.
=-=273 - Sun Jan 24 11:43:41 PST 2010
http://arclanguage.org/item?id=11187
=-=277 - Sun Jan 24 13:59:57 PST 2010

Tell people when you're falling back to random. Test query: "bored cricket
crazy indians"
=-=282 - Mon Jan 25 11:55:57 PST 2010

Daniel Markham's idea: a news ticker.
js from http://www.mioplanet.com/rsc/newsticker_javascript.htm
"free for personal and commercial use"
=-=287 - Mon Jan 25 17:32:22 PST 2010
Hack it to update ticker contents from a second div if they exist.
=-=288 - Mon Jan 25 17:33:49 PST 2010
Basic ticker now working inside arc.
=-=289 - Mon Jan 25 20:24:00 PST 2010
Cleanup. The ticker js requires width to be in the style tag, but the rest can
be in the css file.
=-=290 - Mon Jan 25 20:35:39 PST 2010
Ticker js now showing live feeds.
Periodically updating the ticker isn't working yet.
Also, we're seeing too little at once, it's moving too sluggishly. There's no
sense of a menu.
=-=291 - Mon Jan 25 21:32:24 PST 2010
Ticker js/css bugs fixed.
=-=292 - Mon Jan 25 21:44:28 PST 2010
Smaller font-size helps. And it's now starting with a populated ticker.
There's too few options, and that's partly because many feeds are too long. I
could try trimming and whatnot.. but what if I make each option stand
vertically, and trim past some height?
=-=293 - Mon Jan 25 21:50:18 PST 2010
To make it cross-browser I'd need to get into SVG:
  http://bytes.com/topic/javascript/answers/721811-solution-display-text-rotated-90-vertically-firefox-css
Ok, give up.
=-=294 - Mon Jan 25 21:55:12 PST 2010
Just trim the titles. Verified it's working on Safari, Firefox, Chrome on Mac.
=-=295 - Mon Jan 25 22:10:52 PST 2010
Copy tweaks, some cleanup.
=-=296 - Mon Jan 25 23:15:43 PST 2010

Always first show first item from requested feed before branching out.
=-=297 - Tue Jan 26 00:42:54 PST 2010

Feedback form.
=-=299 - Tue Jan 26 10:17:40 PST 2010
Make feedback form work on not just the first load of a station. Requires
threading station everywhere, yuck.
=-=300 - Tue Jan 26 10:46:21 PST 2010
Eliminate redundant work when user reloads a page.
In the process I've also fully separated index.arc from the current-station
hack. Now only ui.arc is infected.
=-=301 - Tue Jan 26 10:57:08 PST 2010
A function called station was a bad idea. Go all the way, evict
current-station out of index.arc. It's ok to refer to userinfo* in ui.arc. All
tests passing. Navigation working, feedback links working, reloading a station
doesn't change the doc on the user.
=-=302 - Tue Jan 26 11:18:40 PST 2010

Long overdue: replace weird or='s with inittab.
=-=303 - Tue Jan 26 11:52:51 PST 2010

Bugfix: now we use the station variable for more than the feedback link, so
/doc can't just set it to nil.
=-=304 - Tue Jan 26 11:54:06 PST 2010

Fucking refill-metadata is killing us. New threads are not cheap in mzscheme.
Debug why we're updating feed-docs before metadata.
=-=306 - Tue Jan 26 12:04:12 PST 2010
Hmm, just always try to update metadata?
=-=307 - Tue Jan 26 12:06:55 PST 2010
Fixed.

I'd forgotten that persisted is again creating a let scope.
This patch was hard because macros can't need to be at the top level. No do's
or let's or they won't be accessible from outside.

The segfault is back.
=-=308 - Tue Jan 26 14:31:54 PST 2010
I've confirmed that it's happening inside stem. Now down the rabbit hole to
debug it with a C++ program. I have a trace of all the inputs fed to stem.
That should suffice to recreate.
=-=309 - Tue Jan 26 15:45:38 PST 2010
No, C++ program crunches through the trace just fine.
I'm calling it from multiple threads. That's the problem.
=-=311 - Tue Jan 26 16:14:45 PST 2010
No, it can't be a multi-threading issue since I've seen it segfault before the
webserver ever comes online. At that point it's only the defrep calling
canonicalize.
=-=312 - Tue Jan 26 16:28:04 PST 2010

Bugfix: you never want a feed in the showlist that doesn't have an unread
item.
I was violating the constraint by having dup feeds without enough unread
items.
=-=315 - Tue Jan 26 17:28:42 PST 2010

I think the server performance issues and the multiple timeout messages are
related. The number of threads keeps shooting up.
Let's begin by simply watching the numbers go up.
=-=316 - Tue Jan 26 18:00:14 PST 2010
Start looking at the thread distribution. Required modifications to arc.
=-=317 - Tue Jan 26 20:53:00 PST 2010
Apache rewrite rule to filter spam, and changes to help arc distinguish IP
addresses from behind apache. We're now at the point where bare-bones asv can
run without timeouts. readwarp still acting up.
=-=318 - Wed Jan 27 06:13:36 PST 2010
Stop tinkering with srv's abusive-ip parameters, just block the two IPs that
are causing problems now.

Next up: the error that popped up yday:
  Function call on inappropriate object |
  === context ===
  create-doc-feed
=-=319 - Wed Jan 27 12:26:36 PST 2010
Corrupted docinfo. I really should be checking integrity when I load
snapshots. Done.
=-=320 - Wed Jan 27 14:02:48 PST 2010
The new tests were passing the first time, but failing after.
To make testing easier initialize on load-snapshot if var is bound *or nil*.
=-=322 - Wed Jan 27 14:12:11 PST 2010
Just saw random-new get into an infinite loop. I'm not able to recreate, but
let's eliminate the possibility.
=-=324 - Wed Jan 27 19:03:05 PST 2010

Still seeing the occasional timeout. Let's see if slightly growing threadlife
helps.
=-=325 - Wed Jan 27 20:12:19 PST 2010

Another set of timeouts optimized away.
=-=328 - Fri Jan 29 01:57:14 PST 2010

Cleanup utils. The string-processing stuff is cool, but it's so slow I haven't
used it in forever. Discovering striptags is the last straw.
=-=329 - Fri Jan 29 02:20:53 PST 2010

Form-input bugs: urlencode, get rid of quotes.
=-=330 - Fri Jan 29 02:30:32 PST 2010

newsticker tweaks.
=-=332 - Sat Jan 30 19:03:43 PST 2010

History navigation: don't show links when there's nothing to point at, and
update the nav links when the user grows history past 10 elements.
Am I missing any boundary conditions? If the user is on a different history
page, he has more than 10 items in history, so no change is necessary. The
nav has links so more than 1 child, so no change will happen.
=-=334 - Sun Jan 31 16:49:05 PST 2010

Include station name in history requests so multiple users don't conflict.
=-=335 - Sun Jan 31 17:24:07 PST 2010

Start of user accounts. This should be really straightforward, setting a few
people up with user accounts. Why did I agonize so much?
Validate your hypotheses, yes. But don't bother agonizing over something
that'll take just a couple of hours.

Next: req -> user? Use get-user.
=-=336 - Mon Feb  1 00:33:45 PST 2010

Making the buttons look like buttons is so easy. Why did I put this off?
Now putting the labels on the buttons is super ugly.
=-=339 - Mon Feb  1 12:52:11 PST 2010

New button set. 'More from this feed' button.
=-=341 - Mon Feb  1 13:35:43 PST 2010
Bugfixes, cleanup.
=-=342 - Mon Feb  1 14:37:03 PST 2010
History panel now takes 25 elems per page, and is more cleanly refactored.
=-=345 - Mon Feb  1 20:03:35 PST 2010

User accounts, step 1: make current-user take req as an arg.
=-=346 - Mon Feb  1 20:14:10 PST 2010
User accounts done.
Non-logged in user is now nil, not 0.
All non-logged-in users still share history. Next up: generate unique users
per session.
=-=347 - Mon Feb  1 20:43:06 PST 2010
refactor.
=-=348 - Mon Feb  1 22:49:07 PST 2010
I'm running tickupdate constantly while a user is on this page. That seems
wasteful.
Leave it for now; helps measure session length.
=-=349 - Mon Feb  1 22:52:33 PST 2010

I should now have stamped out all bugs in URL escaping.
=-=350 - Mon Feb  1 23:12:37 PST 2010
Load preferred feeds for users.
=-=351 - Mon Feb  1 23:54:03 PST 2010

Fixed login flow.
=-=353 - Wed Feb  3 14:53:11 PST 2010
New nav bar. Functionally good on /, but renders poorly on firefox. Too much
margin above nav.
=-=355 - Wed Feb  3 16:43:25 PST 2010

Start sending bad queries into feedback.
=-=361 - Wed Feb  3 19:18:43 PST 2010

Finally a fix to the "NYT > Travel" issue. Turns out it didn't have anything
to do with urlencode after all.
43 folders seems to work without them, but let's include 0-9 anyway.
=-=362 - Wed Feb  3 21:25:22 PST 2010

Refactor. Tests now pass.
Reorg. req isn't implicitly passed, and I minimize passing it around.
Bugfixes: history_size, write-feedback.
=-=365 - Wed Feb  3 22:55:50 PST 2010

Simpler autosave. Just save state every 5 mins. Now we can have nested tables.
=-=366 - Wed Feb  3 23:20:58 PST 2010
Userinfo now persistent.
=-=367 - Wed Feb  3 23:24:40 PST 2010
Eliminate the odds of losing docinfo data when quitting. Now we only lose data
when we segfault, and we can lose some userinfo data right at the end.
=-=368 - Wed Feb  3 23:49:52 PST 2010
Ok, now we can't lose userinfo either. Short of dying we shouldn't ever lose
data.
=-=369 - Wed Feb  3 23:52:46 PST 2010

I'm persistently losing data from feed-docs. Is that snapshot not getting
saved?
=-=370 - Thu Feb  4 00:03:59 PST 2010
It seems saving docinfo was just never working, lately. So even saving the
75MB docinfo takes 4 minutes.
It's just too inefficient to save the entire table because of one change.
Time to get ourselves a database?

docinfo is a special kind of table. You could write it as multiple segments,
load them all up on startup, and write just one segment every now and then.
Even GC is easy - just don't load some segments.
=-=371 - Thu Feb  4 11:15:07 PST 2010
Tables persisted in multiple chunks, with helpers to convert existing snapshot
files into chunked format.
=-=374 - Fri Feb  5 14:33:39 PST 2010
Done migrating docinfo to new chunked format.
=-=376 - Sat Feb  6 15:54:24 PST 2010
Cleanup.
=-=377 - Sat Feb  6 15:56:18 PST 2010
Ah, wasn't actually using the preferred feeds in stations.
=-=379 - Sat Feb  6 16:14:31 PST 2010
Make chunked-persisted vars robust to file reloads.
=-=380 - Sat Feb  6 16:18:18 PST 2010

FUCK, I had my data at /app/readwarp after deleting the amazon backup volume,
and forgot that I was rsyncing to that directory.
We're starting with a fresh fucking index.
=-=381 - Sat Feb  6 22:40:49 PST 2010

Bugfix: don't just throw all my preferred feeds on there.
=-=384 - Sun Feb  7 11:59:52 PST 2010

Save cleaned docs so you can go over them after a segfault.
=-=385 - Sun Feb  7 14:02:25 PST 2010

First bug from testing logged-in flow but not logged-out.
I'm gonna start needing controller tests.
=-=386 - Mon Feb  8 09:56:04 PST 2010

Logging for a couple of insidious errors that keep cropping up in a
non-reproducible way.
=-=388 - Tue Feb  9 16:43:12 PST 2010
Let's see if this fixes all the errors.
=-=390 - Wed Feb 10 11:59:06 PST 2010
Cleanup.
=-=391 - Wed Feb 10 12:04:03 PST 2010

Stop cluttering up the logs with tickupdates.
=-=394 - Mon Feb 15 10:03:09 PST 2010

Eliminate useless prns, especially the one that ends up in website output
through the sref event.
=-=397 - Tue Feb 16 00:45:30 PST 2010

I'm sick of economics working as a station, but not economy. Fix that stemmer.
=-=398 - Tue Feb 16 00:52:33 PST 2010
Stop google crawling stations.
=-=399 - Tue Feb 16 00:53:29 PST 2010

Let's allow queries to narrow down to more than just one group.
=-=401 - Tue Feb 16 10:03:50 PST 2010
Done. Still todo: update mark-read to gradually delete groups.
A few weeks ago I tore out the state machine in mark read. Now I'm starting to
see some long sessions, it's time to put it back. Along with the ability to
ask before deleting if it's not cut-and-dried.
=-=402 - Tue Feb 16 11:38:38 PST 2010

save-snapshot now has an eval so it's generating a new timestamp/file for
every single save. Wasteful. Go back to once per session.
=-=404 - Tue Feb 16 12:27:01 PST 2010
Stop persisting tables you don't need.
=-=405 - Tue Feb 16 12:55:30 PST 2010

Initial experiments adding ability to ask a user a question before marking a
story as read.
=-=409 - Wed Feb 17 10:52:53 PST 2010
Lesson: you can't name a function or macro a. Renaming to w/jslink.
=-=410 - Wed Feb 17 11:21:02 PST 2010
Ok, I've settled on a good syntax:
  (w/jslink (update :into id
                    :with url
                    :check predicate
                    :popup copy
                    :addarg arg)
    (pr "click here"))
Step 1 complete: simple onclick rather than with.
=-=413 - Wed Feb 17 11:45:00 PST 2010
New test still failing. I'm not sure where I should be adding the single
quotes for js.
=-=414 - Wed Feb 17 11:59:12 PST 2010

Server had been failing since noon yday. Fixed production at 1pm today. I need
to be logging and sending email on errors.
Still fixing the issue. Should work now, but it can take a long time to
iterate over the entire list of feeds if I start out without narrowing down to
any groups.
=-=420 - Wed Feb 17 15:27:47 PST 2010
Much faster after I stopped running that keep on the entire feed list. Now we
simply keep picking a random feed and check it against our conditions until we
have enough.
=-=422 - Thu Feb 18 02:17:16 PST 2010

This is a really weird bug: dhash isn't working.
But if I reload state.arc it works.
Tests all pass.
=-=423 - Thu Feb 18 03:10:10 PST 2010
Ack, name conflict.
=-=424 - Thu Feb 18 03:29:48 PST 2010

The remaining error is one of data integrity. When I add fields to station,
how should I go about updating existing stations?
=-=425 - Thu Feb 18 03:38:37 PST 2010
Manual migrations for now.
=-=426 - Thu Feb 18 03:56:59 PST 2010
Final bugfix: skip nils generated by findg.
=-=429 - Thu Feb 18 04:51:57 PST 2010

Was still saving new snapshot files every 5 minutes. Now fixed.
=-=427 - Thu Feb 18 10:37:52 PST 2010
Cleanup.
=-=428 - Thu Feb 18 10:38:20 PST 2010

Minor refactoring. I'm getting back into js generation from commit 414.
=-=430 - Thu Feb 18 12:02:07 PST 2010
Ok, almost exactly 24 hours later I'm back at commit 414. That test is still
failing.
=-=431 - Thu Feb 18 12:06:56 PST 2010
Single quotes for js now should work properly. My heuristic is as follows: if
the url has a single quote at the start or end, don't quote.
I may end up with situations like abc + confirm('a') but that's unlikely.
More importantly, I may end up quoting a js expression like foo('a')+bar('b').
=-=433 - Fri Feb 19 11:33:13 PST 2010

There's lots of reasons findg gives up. It's not always exceptional.
=-=434 - Fri Feb 19 20:36:02 PST 2010

Some cleanup in how I choose the next 5 feeds. I need to bring back the state
machine in some form.
=-=435 - Fri Feb 19 21:07:31 PST 2010

This is taking too fucking long. Deep breath. We now have a front page that'll
show you all your preferred feeds. Only works for logged-in users.

I need to do shit like this more often. Thank you, Julie and Julia.
=-=436 - Sat Feb 20 00:08:43 PST 2010
More navigation in the layout. I'd just been putting this off for no good
reason. Ugly as hell, but get the information on there.
=-=437 - Sat Feb 20 01:11:34 PST 2010
Lots of duplicated crap. We'll deal with it.
=-=440 - Sat Feb 20 01:29:36 PST 2010

Deleting stations. Ugly as hell, but works. Now let's polish the interaction.
=-=443 - Sat Feb 20 09:47:38 PST 2010
Now clicking delete doesn't reload the page.
=-=444 - Sat Feb 20 09:55:21 PST 2010

Add logs to the daily email?
=-=447 - Sat Feb 20 19:57:04 PST 2010
Nah, that won't group them by user. I need to spend more time doing analytics
from within arc.
=-=448 - Sat Feb 20 19:58:36 PST 2010

Random often generates nerdy blogs. Even group often generates nerdy; there's
just so many technology/programming blogs that lots of keyword return those
groups.
Hackish solution to the latter problem. Let's see if we have been
over-aggressive in pruning nerdy blogs.
=-=449 - Sat Feb 20 20:19:33 PST 2010

Bugfix: list of feeds had grown stale. Dynamically generate.
=-=450 - Sat Feb 20 20:58:13 PST 2010

The segfaults continue, and they're eroding confidence in the FFI. Let's see
if creating a copy of the output fixes it.
=-=452 - Sun Feb 21 09:36:48 PST 2010

Bugfix: logged-in users who didn't give me their feeds would see nothing on
their front page.
=-=453 - Sun Feb 21 10:09:45 PST 2010

I showed the reload op to Idoh. It's a security hole and I'm not really using
it. Disable.
At some point I'll make it an admin op.
=-=454 - Sun Feb 21 10:39:28 PST 2010

Stations would lose the unpreferred table after restart because empty tables
turn into nils. Hmm, perhaps I should automatically assume nils are tables.
Otherwise they wouldn't be there.
=-=456 - Sun Feb 21 10:55:55 PST 2010
Ok, here's a better fix. In the process I added more test cases and found a
bug when fread reads non-tables (say lists).
=-=457 - Sun Feb 21 11:19:22 PST 2010
In the process I saw a test fail once non-reproducibly. Let's monitor that.
=-=458 - Sun Feb 21 11:19:58 PST 2010

Yet another bugfix to handle uninitialized stations.
=-=460 - Sun Feb 21 15:34:37 PST 2010

refactor names: station vs sname
=-=461 - Sun Feb 21 15:36:23 PST 2010
refactor names: new-staton -> ensure-station; new-user -> ensure-user
=-=462 - Sun Feb 21 15:40:21 PST 2010

Still exterminating intermittent errors on production. This time we just log
to figure out what may be going on.
=-=463 - Sun Feb 21 15:47:23 PST 2010

After commit 458 I'd rolled back to 456 on production because I saw showlist
to be nil in a snapshot and get interpreted as a table. It shouldn't happen.
If showlist is nil it should not exist in the table.

Just one snapshot has that. Let's see if we can get rid of it and see if it
comes back.
=-=464 - Sun Feb 21 21:34:39 PST 2010

Argh, syntax error from patch 463. System died when I showed naval; one of the
few times I've missed a static type checker.
=-=467 - Mon Feb 22 12:53:19 PST 2010

I'm seeing more data integrity issues. How does showlist ever become nil? How
does it become ""?
Data is now clean. Let's see if this happens again.
=-=468 - Mon Feb 22 13:54:27 PST 2010

Starting to force myself to work on the state machine. Why is this so hard?
=-=469 - Mon Feb 22 19:19:53 PST 2010
Exponential back-off: if I ask you to delete a feed after 2 attempts and you
say no, wait 4 attempts before asking again.
The confirmation part is still not there.
=-=470 - Mon Feb 22 20:16:41 PST 2010
Still not feeling in control of this feature. Writing a few test cases to
enumerate how far I've gotten.

Things I'm still struggling with:
  passing group with a feed? perhaps I should address downvotes to all groups.
    that implies I should try to pick stories without ambiguous groups.
  deleting groups for a station.
=-=471 - Mon Feb 22 20:38:10 PST 2010
Feeds can belong to multiple groups.
=-=472 - Mon Feb 22 21:11:47 PST 2010
Bugfix: sometimes we'd show 2 stories from the seed station. I even heard
reports of more than 2.
=-=473 - Mon Feb 22 21:12:48 PST 2010

Finally, integration tests.
=-=474 - Tue Feb 23 09:42:29 PST 2010
More test case tweaking. read-nested-table tries to return a table.
=-=475 - Tue Feb 23 09:47:50 PST 2010

Eliminate nil stations once and for all.
=-=477 - Tue Feb 23 10:23:44 PST 2010

About to enhance station!groups. First a test case to set a stake down on what
currently works.
=-=478 - Tue Feb 23 13:02:57 PST 2010
Data format changed for station!groups.
=-=479 - Tue Feb 23 16:45:10 PST 2010
Done enhancing station!groups. Surprisingly simple in number of tests, and yet
it was near impossible to keep in my head.
One major insight: the best place to store backoff structures is in tables, so
that we can backoff-check them conveniently.
=-=480 - Tue Feb 23 17:54:49 PST 2010

Let's start formalizing the process of migrating data.
=-=481 - Tue Feb 23 19:13:20 PST 2010
Bugfix: Handle groups for demoted feed that already aren't in preferred groups.

The code is getting messy..
=-=483 - Tue Feb 23 20:22:51 PST 2010
Yet another bugfix.. It's the data stuctures that are getting messy. userinfo
is turning horrendous. I have preferred feeds that aren't in
station!preferred, etc.
=-=484 - Wed Feb 24 10:32:30 PST 2010

Trying to get confirmation dialogs working.
After some thrashing I realize I need to change the interface for
check-with-user.
=-=488 - Wed Feb 24 12:41:45 PST 2010
Ok seems to be working now.
=-=489 - Wed Feb 24 13:02:15 PST 2010

reset is a time-bomb like reload. Also useless to me since userinfo then stops
getting persisted.
=-=490 - Wed Feb 24 13:10:05 PST 2010

Hooked up handle-downvote with mark-read-url. Still breaking. It's a hassle
keeping the two sync'd to avoid both redundant dialogs and dialog-less
backoffs.
=-=492 - Wed Feb 24 14:02:29 PST 2010
Seems to be working now. Only issue: dialog never shows up for groups until
the first feed is preferred in that group.
=-=494 - Wed Feb 24 14:52:55 PST 2010
It wasn't quite that. Anyway, fixed.
=-=495 - Wed Feb 24 14:57:42 PST 2010

Trying to speed up the server by spawning a thread to add to the showlist when
it's running low. To do this, however, I'll need to be able to add to showlist
one by one, so I must normalize probabilities. And existing items in the
showlist shouldn't throw it, so I must manage showlist and last-showlist as
queues to avoid having to reverse the list.

Almost there, but I'm again running into the fact that eval doesn't understand
the lexical environment.
=-=499 - Thu Feb 25 00:53:28 PST 2010
That's fixed now, but the first call to rebuild-showlist blows through my RAM.
=-=500 - Thu Feb 25 01:45:08 PST 2010
Redundant enq in new-doc. Not clear why that was so bad, but it explains qlen
shooting up.

The problem with this approach is that randpick never has a chance to fall
through when preferred returns nil. We have to return docs inside the
randpick.
=-=501 - Thu Feb 25 10:00:16 PST 2010
Just get rid of that macro. This works beauifully!
=-=502 - Thu Feb 25 10:03:43 PST 2010
Back to the macro. Progress, but it doesn't quite work.
=-=503 - Thu Feb 25 10:43:43 PST 2010
Macro seems to be working now.
=-=504 - Thu Feb 25 11:04:52 PST 2010
Cleanup.
=-=505 - Thu Feb 25 11:11:30 PST 2010
Seed a thread right at the start. You don't want a pause on the very first
vote from a user.
=-=507 - Thu Feb 25 11:19:43 PST 2010
Loose end: a user's global channel.
=-=508 - Thu Feb 25 11:25:46 PST 2010
Loose end: handle "more from this site" button.
It's super fast now!
=-=509 - Thu Feb 25 11:57:19 PST 2010
Tests pass.
=-=510 - Thu Feb 25 12:00:38 PST 2010
Bugfix: migration needed to update last-showlist in addition to showlist.
=-=511 - Thu Feb 25 15:03:28 PST 2010
Argh, typo. Still getting over glitches on production.
=-=512 - Thu Feb 25 15:32:01 PST 2010
Cleanup.
=-=513 - Thu Feb 25 15:33:27 PST 2010

Scroll up long pages when clicking a button from the bottom panel.
=-=514 - Thu Feb 25 17:43:46 PST 2010

Update title.
=-=515 - Fri Feb 26 12:03:34 PST 2010

Favicon. will it work? No luck on localhost:8080
=-=517 - Fri Feb 26 12:51:04 PST 2010

Srikanth reported showlist getting corrupted several times today. I spotted it
once as well. More logging to catch that next time.
In the process I've refactored out some recent duplication.
=-=519 - Fri Feb 26 18:09:49 PST 2010

Bugfix: Only n consecutive downvotes should delete groups, not just n
downvotes.
I considered resetting the whole backoff structure so it goes from needing 16
downvotes back to just 4. But rebecca's gotten nagged too frequently in one
case, but never too infrequently.
=-=520 - Fri Feb 26 18:43:40 PST 2010

More logging for Srikanth's error. I can't seem to run into it again.
=-=522 - Fri Feb 26 19:08:53 PST 2010

Bugfix: handling re-likes from the history panel.
=-=524 - Sun Feb 28 09:14:00 PST 2010

Bugfix in patch 520. I really need more tests. First step: fixtures.
=-=525 - Sun Feb 28 19:29:36 PST 2010

htmlcleaning bugfix. It turns out RSS feed descriptions can contain junk the
main page does not. I was discarding perfectly good cleanings because of this.
Example: the share icons in descs for www.boston.com feeds.
Fixed by stripping tags when doing the fuzzymatch. Will this slow things down?
=-=526 - Mon Mar  1 10:03:28 PST 2010
No unnecessary slowdown at least.
=-=527 - Mon Mar  1 10:07:17 PST 2010

Typo. After dealing with three confidence-sapping stability issues - segfault
because of scheme's regex library, queue corruption, button text corruption -
I'm back to looking at the group state machine.
=-=532 - Tue Mar  2 15:00:24 PST 2010
Yet another correction to the group state machine. I'd forgotten that by
setting station!groups.g I'm marking a group as preferred.

Let's write some tests next. Then we'll move on to
front-page/copy/signup-funnel redesign.
=-=534 - Tue Mar  2 19:12:01 PST 2010
Cleanup.
=-=535 - Tue Mar  2 19:37:08 PST 2010

Minor bling.
=-=536 - Wed Mar  3 00:26:18 PST 2010
Nah, undo.
=-=537 - Wed Mar  3 00:26:39 PST 2010

Trying this for the button text corruption issue:
  http://arclanguage.org/item?id=11359
=-=538 - Wed Mar  3 01:26:21 PST 2010

Layout bugfixes for history panel.
=-=541 - Thu Mar  4 00:12:36 PST 2010

If you ever end up with an empty feed at head of showlist, get yourself
unwedged.
=-=542 - Thu Mar  4 00:51:13 PST 2010

htmlclean often seems to return empty text. Debugging.
=-=544 - Thu Mar  4 01:13:21 PST 2010
The problem is character encodings again. Here's an approach that seems to
work.
=-=545 - Thu Mar  4 01:47:07 PST 2010
Cleanup.
=-=546 - Thu Mar  4 01:49:17 PST 2010

A simple refactoring to get back into product improvements after a week of
debugging stability issues.
=-=550 - Sun Mar  7 16:18:38 PST 2010

Refactoring index fixtures for better tests.
=-=551 - Sun Mar  7 19:55:05 PST 2010

I find myself commenting and uncommenting the same code fragments. Hacky:
  $ TEST=true arc
=-=552 - Sun Mar  7 22:30:01 PST 2010

Group state machine now reasonably test driven.
Found a bug in the process; upvoting feeds wasn't actually adding them to the
global station yet.
=-=553 - Mon Mar  8 02:27:50 PST 2010

Perhaps we don't need enqn?
=-=554 - Tue Mar  9 02:00:54 PST 2010

New user per session. But it's still kludgy. I need to distinguish temporary
users so I can use the old non-logged-in UI, GC temporary users, etc.
=-=555 - Tue Mar  9 03:01:08 PST 2010
Done.

When a new user comes to the site, a little piece of javascript creates a
cookie for him. Now the user has a sandbox, a temporary user.
When the temporary user goes through signup we tag the user signedup in
userinfo.

todo:
1. Signup is convoluted. Why does creating a cookie require AJAX? Cleanup when
you move to web.arc
2. Test-drive signup flows.

Bonus: non-logged-in users now get a sense of the logged-in view. They can see
their channels, etc.
=-=556 - Tue Mar  9 03:22:36 PST 2010

New front-page for non-loggedin users. Beginnings of a signup funnel.
=-=557 - Tue Mar  9 03:48:23 PST 2010
Funnel analytics code.

Button still doesn't work. Let's just profligately duplicate code for
starters.
=-=558 - Tue Mar  9 05:01:53 PST 2010
Idoh's comments.
=-=559 - Tue Mar  9 12:28:49 PST 2010
More tweaks to spacing from Idoh.
=-=560 - Tue Mar  9 20:35:39 PST 2010

Funnel buttons now work. Final stage: I need to create the transitional signup
page.
=-=561 - Tue Mar  9 22:32:49 PST 2010
Signup page swaps in the history so far.
What's left? Visual design, and intelligently choosing the pre-signup stories.
=-=562 - Wed Mar 10 08:02:06 PST 2010
A modal dialog implementation from Isaac Schlueter.
  http://foohack.com/2007/11/css-modal-dialog-that-works-right
Still doesn't come on by default, and won't work when you get to the signup
page through ajax.

What am I doing relying on something this complex for the final, money stage
of my signup flow?
There's going to be no overflow; that's in my control. Just hack something
simpler and less reliant on javascript to at least turn on.
Maybe just throw an image together?!
=-=563 - Wed Mar 10 08:46:45 PST 2010
Keep the CSS for the modal dialog, just never use the js. We just want it to
stay put, anyway.
=-=564 - Wed Mar 10 09:22:04 PST 2010
Futzing around while I work up courage for the rest of the copy design.
=-=565 - Wed Mar 10 09:29:29 PST 2010
Copy for the start of the funnel.
=-=566 - Wed Mar 10 10:10:41 PST 2010
Copy for the signup page.
=-=567 - Wed Mar 10 10:20:05 PST 2010
Copy for the first post-signup screen.
Next, copy around the 'new channel' action.
Now we have all the slots for copy, we can start fine-tuning the design.
Rebecca: all the colors are ugly, every single one of them.
Perhaps I should make it all black and white, use icons for thumbs up and
thumbs down.
=-=568 - Wed Mar 10 10:37:19 PST 2010
A monochrome design.
=-=569 - Thu Mar 11 01:08:01 PST 2010
Copy around the 'new channel' action.
=-=570 - Thu Mar 11 01:43:20 PST 2010

Bugfix: a stale cookie shouldn't take users to the end of the signup funnel.
=-=571 - Thu Mar 11 01:56:55 PST 2010

Update signup flow for new style.
=-=572 - Thu Mar 11 02:04:48 PST 2010
Signup form overlays something useful.
Lots of redundant duplication, though.
=-=573 - Thu Mar 11 02:31:22 PST 2010
Better error message when an ajax request dies.
=-=574 - Thu Mar 11 03:06:51 PST 2010

Signup flow shows one story each from major groups.
=-=575 - Thu Mar 11 04:36:17 PST 2010
Cleanup.
=-=576 - Thu Mar 11 04:41:08 PST 2010
Signup flow adds 'related groups' after upvote on one group.
=-=577 - Thu Mar 11 05:15:40 PST 2010
Cleanup.
=-=578 - Thu Mar 11 05:19:51 PST 2010
Fix button styling (srikanth).
=-=579 - Thu Mar 11 12:10:11 PST 2010

Fixed the signup flow of commit 556. No reliance on javascript, no ajax. The
very first response of a session already knows about its sandbox user
variable.

The bad news: all this is now in the arc repo.
=-=580 - Thu Mar 11 13:47:53 PST 2010
I think we're settling into the greyscale theme. But out with the thumbs.
=-=581 - Thu Mar 11 14:49:14 PST 2010
Logo colors.
=-=582 - Thu Mar 11 14:56:08 PST 2010
Regularize greyscale and spacing everywhere.
=-=584 - Thu Mar 11 16:01:39 PST 2010
Less visual clutter in the history panel.
=-=585 - Thu Mar 11 16:06:12 PST 2010
First cut at regularizing font sizes.
=-=586 - Thu Mar 11 16:56:57 PST 2010

Precompute stories to show during signup to minimize latency.
=-=590 - Thu Mar 11 18:49:30 PST 2010
Bugfix. But now load '/' takes too long. Why is there thread conflict?
=-=591 - Thu Mar 11 19:05:56 PST 2010
Seemingly because the rebuild is trying to prn to the string that was already
closed. Fixed. Things are snappy now.
=-=592 - Thu Mar 11 19:34:39 PST 2010
Hack: wait a bit before starting the precompute thread, let the current page
go through first.
=-=594 - Thu Mar 11 19:59:58 PST 2010

Revert arrows to be cross-browser.
=-=595 - Thu Mar 11 23:44:33 PST 2010

More tweaks to the signup flow; a progress bar and don't let people click on
the hidden stuff in the signup page.
=-=596 - Fri Mar 12 09:39:24 PST 2010
Post-signup layout tweaks.
=-=597 - Fri Mar 12 09:54:35 PST 2010

The modal dialog for signup broke scroll-up on next story.
Moving scroll to an inner div is still not perfect -- come back to the page
with the back button, and it forgets its place on the screen.
=-=598 - Fri Mar 12 10:13:03 PST 2010

Bugfix: thread objects can't be persisted.
=-=599 - Fri Mar 12 10:56:10 PST 2010

Moving to a single set of always-accessible buttons.
Tradeoffs:
  an iframe is an extra request
  position:fixed interacts poorly with a centered page
Decision: flush page left.
Separate column for buttons. We waste some space, but there's also room for
other (play mode?) controls.
=-=602 - Fri Mar 12 21:52:33 PST 2010
Tweaks on production now that we've settled on this layout.
=-=605 - Fri Mar 12 22:18:26 PST 2010
CSS is now complex enough that it's starting to interact with tables. Out with
the tables.
=-=606 - Fri Mar 12 22:50:36 PST 2010
Fix signup flow for layout changes. Time to break this out.
=-=607 - Sat Mar 13 00:55:26 PST 2010
Layout bugfix for windows firefox.
=-=610 - Sat Mar 13 17:22:57 PST 2010

New buttons.
=-=609 - Sun Mar 14 00:07:06 PST 2010
Square buttons as rebecca keeps insisting. I could get used to them. They're
still pretty easy to acquire.
=-=611 - Sun Mar 14 00:17:12 PST 2010

Turned on cache control in arc. Ensure changes to static files update
instantly.
=-=613 - Sun Mar 14 00:50:26 PST 2010
Cleanup button template.
=-=614 - Sun Mar 14 01:35:39 PST 2010

Put the scollbars on an inner div only in the signup flow. That way logged in
users can still scroll without first needing a click on the page.
=-=615 - Sun Mar 14 01:37:06 PST 2010

Break signup into its own file.
=-=616 - Sun Mar 14 01:38:47 PST 2010

Refactor.
=-=617 - Sun Mar 14 13:54:19 PDT 2010
Copy on station creation.
=-=618 - Sun Mar 14 13:55:01 PDT 2010

Apply GC on feed-docs*.
=-=619 - Sun Mar 14 15:44:50 PDT 2010

Enq items into signup-showlist rather than building it in one
latency-consuming operation.
=-=620 - Sun Mar 14 15:59:22 PDT 2010

First cut at making docinfo non-persistent. Loading 10k files is taking too
long.
=-=622 - Sun Mar 14 18:47:22 PDT 2010
We need a way to maintain a consolidated snapshot of docinfo. Let's just keep
doing the chunked-persisted thing. Maybe a naming convention to say it's not
essential?
=-=623 - Sun Mar 14 19:06:52 PDT 2010
Cleanup. Deemphasize docinfo - all it's doing is acting as a cache.
Should I rename it?
Should I move it lower down index.arc?
=-=624 - Sun Mar 14 19:12:53 PDT 2010

Don't show the spinner error messages multiple times.
=-=627 - Mon Mar 15 13:04:49 PDT 2010

Cleanup signup css based on email from Andy Harrison.
=-=629 - Mon Mar 15 13:28:51 PDT 2010
Bugfix in signup flow. I was dequeuing too quickly so user never made it
through the funnel.
=-=630 - Mon Mar 15 14:26:01 PDT 2010

I'm concerned we are or will soon run into realtime constraints with
mzscheme's GIL. Let's start logging times.
=-=631 - Mon Mar 15 14:34:29 PDT 2010

Don't let wait messages show from previous stages of the funnel.
=-=632 - Mon Mar 15 15:59:40 PDT 2010

Bug in 631's change to new-thread: wasn't returning the thread value.
=-=633 - Mon Mar 15 16:13:26 PDT 2010

Argh, js bugfix. Readwarp was non-functional for 9-12 hours.
=-=634 - Mon Mar 15 23:08:44 PDT 2010

Figured out how to convert ascii queries to unicode as appropriate!
=-=636 - Tue Mar 16 03:32:36 PDT 2010

Feedback form wasn't working since Friday.
=-=637 - Tue Mar 16 12:39:45 PDT 2010

Rebecca went through the signup funnel. Copy change suggestions.
She thinks new users would still be quite confused after signing up.
=-=639 - Tue Mar 16 15:14:44 PDT 2010

Bring back the daily email on poorly-performing queries.
=-=640 - Tue Mar 16 16:37:50 PDT 2010

Start backing up user votes.
=-=641 - Tue Mar 16 17:03:19 PDT 2010
Update crontab
=-=642 - Tue Mar 16 17:06:46 PDT 2010

Reorganizing feeds before implementing Private feeds.
=-=643 - Tue Mar 16 22:03:52 PDT 2010
Private feeds. They get crawled but they're not in any feed lists or any feed
groups. The only way you can find them is if you search for them.
=-=644 - Tue Mar 16 22:05:20 PDT 2010

New feature: save to read later. Saving to a list is easy. But how to show the
saved list?

To minimize our work we'll cut several corners:
a) Where should the link to bookmarks be? Options: as another channel, or on
the nav next to user name. Put it to the right of the 'new channels' header.
It is always visible.
b) No list mode. Just fit the bookmarks page into the existing design.
c) What does voting on a story from bookmarks page do? Nothing. It's detached
from the parent station. But still keep the vote buttons for navigation. They
basically have the same effect.
d) Navigation within the bookmark list doesn't delete from the list. So you
can keep rotating through your bookmarks.
e) Pagination within bookmark history should rotate as well.
=-=645 - Tue Mar 16 22:48:27 PDT 2010
Positioning the link as a separate item on the left. How to indicate that
you're browsing bookmarks? I'll move the link up.
=-=646 - Tue Mar 16 23:10:49 PDT 2010
Refactoring the left panel in preparation of duplication.
=-=647 - Tue Mar 16 23:23:39 PDT 2010
Refactor history panel.
=-=648 - Tue Mar 16 23:25:33 PDT 2010
Hmm, should the bookmarks be in a queue or a list?
A list is easier when we want to be able to unbookmark items at random.
A queue is easier to implement rotation.
Perhaps just a list and an index.
=-=649 - Tue Mar 16 23:35:25 PDT 2010
But how to keep index from jumping around in the presence of random deletions?
=-=650 - Tue Mar 16 23:38:05 PDT 2010
Refactor doc-panel in preparation of duplication.
We're putting off what happens on bookmark navigation for now. Assume it'll be
a slow rotation operation.
=-=651 - Tue Mar 16 23:45:26 PDT 2010
Closed the loop. Doc page now renders but buttons don't work. We may have to
duplicate further.
=-=652 - Wed Mar 17 00:22:29 PDT 2010
The most compelling model seems to be to do the reverse of pushHistory. So in
the bookmarks channel stories come off the left panel to show up on the main
panel.
How to update both history and doc? I'm trying two inlines in parallel, but
the ajax requests happen in parallel, so the history panel can go out of sync.
=-=653 - Wed Mar 17 01:23:30 PDT 2010
This seems to work. Inelegant way to get around javascript's lack of a sleep
function.
=-=654 - Wed Mar 17 01:47:35 PDT 2010
Bugfix: name collision.
=-=655 - Wed Mar 17 01:51:22 PDT 2010
No bookmark message was getting suppressed. Why was the checkContent limit so
high?
=-=658 - Wed Mar 17 12:39:23 PDT 2010
Add a little copy to the bookmark icon (nivi).
That call to jstogglelink is getting a little hairy. But I don't know how to
elegantly refactor it. The different stuff is quite deep inside.
=-=659 - Wed Mar 17 12:49:16 PDT 2010
Useful side-effect: tinkering with the buttons doesn't break the rest of the
page since they're right at the end.
=-=660 - Wed Mar 17 13:03:54 PDT 2010
Fixed.
=-=661 - Wed Mar 17 13:05:32 PDT 2010

Fuck, last night's bookmark hacking broke the signup page. I need to be
testing this.
=-=662 - Wed Mar 17 13:20:06 PDT 2010
Ok, here's a test.

Moved to production to test drive after hanging production and needing to
restart.
=-=663 - Wed Mar 17 13:44:08 PDT 2010

Refactor: replace string id's and classes in html with symbols.
=-=664 - Wed Mar 17 13:51:25 PDT 2010
Trying to get rid of the ugly blue underline on hover in a couple of places.
No luck. Firebug not helping with this one.
=-=665 - Wed Mar 17 13:52:35 PDT 2010

PG's feed has bugged me for the last time with its timestamp-less out-of-order
items.
I never see any other feeds with this problem, so let's just hack it.
=-=667 - Wed Mar 17 20:17:04 PDT 2010
Done. Now it'll update json timestamps.
=-=668 - Wed Mar 17 20:36:13 PDT 2010

Prefix all css id and class names to eliminate the possibility of conflict
from some document.
=-=669 - Wed Mar 17 21:14:24 PDT 2010
Stop recording randomness in empty channels.
Cleanup: if -> when, unless-or -> if-neither.
=-=671 - Thu Mar 18 09:04:31 PDT 2010

I still wasn't logging thread durations correctly. Gotta do the logging inside
the thread.
=-=676 - Fri Mar 19 10:28:26 PDT 2010

Show who came to readwarp in the daily email.
=-=677 - Fri Mar 19 10:57:51 PDT 2010

Every hour, autosubmit a story from economics to Jonathan Nelson's
newsley.com.
=-=680 - Sun Mar 21 11:57:49 PDT 2010

Add simple funnel summary to daily email.
=-=681 - Sun Mar 21 13:30:28 PDT 2010

Summaries when autosubmitting.
=-=682 - Sun Mar 21 16:42:40 PDT 2010

Struggling to understand arc's performance bottlenecks.
=-=683 - Mon Mar 22 16:08:12 PDT 2010
A couple of utilities:
1. prn-stats2 that doesn't need to wait on atomic sections.
2. Dumping stack traces. dump-stack-trace2 still doesn't work after
translating from scheme.
=-=684 - Wed Mar 24 15:10:53 PDT 2010
Eliminating the prefetch thread improves performance. 10 new users at a time
in <4s, 100 at a time in <25s.
=-=686 - Wed Mar 24 16:25:53 PDT 2010
Bugfixes. random-story-from can now never return nil.
=-=687 - Wed Mar 24 16:50:02 PDT 2010
Nope, perf on readwarp server has actually degraded. Undo 686-688.
=-=689 - Wed Mar 24 18:06:03 PDT 2010
Eliminated prefetch thread for logged in users. Readwarp can now handle 6
concurrent users. At 6 requests start taking over 10s. But for single users
it's still under a second.
=-=691 - Fri Mar 26 11:01:17 PDT 2010
Cleanup. We no longer watch what stories you saw recently, so you may
accidentally see the same feed pop up multiple times. In particular people
with a few preferred feeds will have a hard time going outside them. I should
bias the odds of preferred feeds down at some point.
=-=692 - Fri Mar 26 11:40:43 PDT 2010
Refactor. I don't like the name: always. What's the alternative?
=-=693 - Fri Mar 26 12:18:08 PDT 2010

After a day reimplementing in SBCL, and having an angsty sort of conversation
at http://arclanguage.org/item?id=11505, aw's comments at
http://arclanguage.org/item?id=11533 and below get me to return to this repo
to reduce the 650-800ms fixed cost per request. Most of the time is being
spent computing stories, and there's a lot of iteration over long lists for
randpos, and for computing the lists to randpos over.

First cut at fixing that is to introduce a cache that makes random selection
faster. Now latency is halved, but I'm no longer sure it's correct, that I'm
invalidating the cache everywhere I should be. Don't make it a cache, change
the actual data structures to allow fast random selection.
=-=695 - Sun Mar 28 02:04:36 PDT 2010
Reorg.
=-=696 - Sun Mar 28 02:11:50 PDT 2010
New data structure completed - constant-time insert, delete, lookup,
random-select.
=-=697 - Sun Mar 28 03:11:20 PDT 2010
Integrate backoff into it. Now we should never del-rrand directly.
=-=699 - Sun Mar 28 04:29:33 PDT 2010
Clean slate for index.arc from my previous hacks.
Ensure tests all pass. Fixed signup controller test that was polluting
userinfo*.
=-=700 - Sun Mar 28 04:47:25 PDT 2010
Refactor feeds to take station directly.
=-=701 - Sun Mar 28 04:51:05 PDT 2010
Bugfix: add-rrand wasn't creating backoff.
Enhancement: rrand-backoff-clear.
=-=702 - Sun Mar 28 05:27:19 PDT 2010
First integration of rrand into the app; station!groups is now an rrand data
structure.
=-=706 - Sun Mar 28 06:41:35 PDT 2010
Intermezzo: Rather than compute preferred-feeds for a station every request,
simply initialize them correctly from the user's global preferred-feeds and
update as necessary.
Upvotes add to a user's preferred feeds, but downvotes never remove from it.
=-=707 - Sun Mar 28 07:00:17 PDT 2010
Almost done; station!preferred is now an rrand data structure as well.
=-=708 - Sun Mar 28 08:16:35 PDT 2010
Final step: make choose-from-random use an rrand as well.
=-=709 - Sun Mar 28 08:26:24 PDT 2010
Ah, one more long pole in the tent: most-recent-unread.
=-=710 - Sun Mar 28 09:43:15 PDT 2010
Fuck, that's the only long pole all along. Why didn't I start using deftimed a
week ago?
1. At the start timings were flaky, which led me astray.
2. most-recent-unread is a lot of stuff in just one line, making it easy to overlook.
3. I stopped including times.arc for a few months. I'd basically forgotten it existed.

Reverting to patch 693.
=-=711 - Sun Mar 28 10:22:29 PDT 2010

Let's take a breather. Pending patch since last night. I discovered that my
changes to the htmlcleaner of Mar 4 immediately caused more files to not be
cleaned. Just roll that change back for now. Reverting to htmlclean.py of
patch 527 from Mar 1.
=-=712 - Sun Mar 28 10:27:51 PDT 2010
Hackish attempt at connecting up with a user.
=-=713 - Sun Mar 28 10:28:27 PDT 2010

Start including times.arc so we start using it every few weeks.
Start measuring ab latency more often.
=-=714 - Sun Mar 28 10:58:51 PDT 2010

Bringing back some refactorings from last night.
=-=715 - Sun Mar 28 11:14:39 PDT 2010
Did we still have this vestigial call through all this? Doesn't look like I
took it out overnight.
=-=716 - Sun Mar 28 11:55:05 PDT 2010

Finally, the performance optimization. A one-line change and a migration takes
readwarp from 50% timeouts at 6 users to 15% timeouts at 100 concurrent users.
  http://arclanguage.org/item?id=11556
=-=717 - Sun Mar 28 12:58:24 PDT 2010
That was on localhost. Over the network it's just 10-15 concurrent users
without timeouts.
But now I've stopped preloading docinfo and now I can get 25 concurrents.
=-=721 - Sun Mar 28 14:44:46 PDT 2010

Bugfix. Again I haven't been running my unit tests before pushing to
production. Tests were failing since commit 715.
=-=723 - Mon Mar 29 20:14:31 PDT 2010

Make most-recent-unread slightly more efficient yet, eliminate a bunch of
unnec conses.
=-=725 - Tue Mar 30 10:31:26 PDT 2010

Uncamelcase groups in the popup.
Some reorg.
=-=726 - Tue Mar 30 11:24:34 PDT 2010

Bugfix: downvote now won't ever demote any group but the one it popped up for.
=-=727 - Tue Mar 30 11:25:29 PDT 2010
Push that change through to UI.
=-=728 - Tue Mar 30 11:37:11 PDT 2010
I didn't have it quite right: I only provide a group when downvoting to
suppress it. But backoff was never building then. Solution: if no group is
given, backoff all groups for this feed like before.
All tests pass again.
=-=729 - Tue Mar 30 12:15:25 PDT 2010

Faster startup and simpler defrep as I percolate the implications of not
needing docinfo to be persisted.
=-=730 - Tue Mar 30 20:43:48 PDT 2010

Signup copy tweaks.
=-=732 - Tue Mar 30 20:46:43 PDT 2010
Draft of a half-broken decision tree data structure for A/B testing.
But it's got issues.
=-=733 - Tue Mar 30 21:17:36 PDT 2010

R's running into lack of diversity. Bring back neglected unread. But is this
fast enough?
=-=734 - Tue Mar 30 21:27:16 PDT 2010
Simple performance test. Previous commit doesn't degrade performance.
=-=735 - Tue Mar 30 21:43:59 PDT 2010

A simple A/B test to start. Does the bold call to vote up help improve
conversions at the worst stage in the pipeline?
=-=736 - Wed Mar 31 02:41:20 PDT 2010

Update daily email to separate new from returning users.
=-=739 - Wed Mar 31 15:28:25 PDT 2010

Update preferred feeds after the user has been initialized.
=-=740 - Thu Apr  1 12:40:28 PDT 2010

Signup funnel was ending before the actual act of signup. Hopefully not a big
deal; we'll see.
Another bug: post-signup copy wasn't showing up because it was hidden under
the signup box. Needed to be on the next screen.
=-=741 - Fri Apr  2 11:33:59 PDT 2010

Refactoring in preparation of redoing the signup screen. I want to make the
email address mandatory when signing up. Hmm, just rename username to email
address?
=-=743 - Fri Apr  2 19:35:22 PDT 2010
Done. What could go wrong? We're not even saving usernames as filenames.
=-=744 - Fri Apr  2 19:53:48 PDT 2010

Argh, my abtest wasn't working. Fixed.
=-=745 - Fri Apr  2 23:16:39 PDT 2010

Some users were seeing an error in stage 2 of the funnel. Ben Silberman, some
mturkers. It seems abtests was nil when I was trying to run tablist on it.
Guard against this. But why is it happening?
=-=746 - Sat Apr  3 10:53:18 PDT 2010

Ack, memtable when I meant backoffify. This is what luliu was running into.
=-=747 - Sat Apr  3 11:11:30 PDT 2010

Quick and dirty change-password form. Zero error checking, no redirection.
=-=748 - Sun Apr  4 14:55:00 PDT 2010

Reload shouldn't move to a new article.
=-=749 - Sun Apr  4 15:03:13 PDT 2010

Nice copy fix for the ok/cancel problem. Ramki's idea.
=-=750 - Sun Apr  4 18:44:12 PDT 2010

Reset password now redirects to '/'.
=-=751 - Sun Apr  4 18:48:38 PDT 2010

Bookmarklet for people to submit sites. Almost works - the request doesn't
hold the user.
=-=752 - Sun Apr  4 19:15:07 PDT 2010
Make sure people don't have to update their bookmarklet when you make it
suck less.
=-=753 - Sun Apr  4 19:19:32 PDT 2010
Bookmarklet tweaks. Copy, and an utterly insecure way to provide username.
=-=754 - Sun Apr  4 20:03:21 PDT 2010

Back to the html cleaner.
=-=755 - Wed Apr  7 22:26:19 PDT 2010
Turns out just getting rid of 'encode(utf-8)' makes things much better.
Get rid of all the test framework and debug crap. We don't really know what
we're doing yet.
I've started following the readability plugin. How can I directly use
improvements to it? Firefox plugin?
=-=756 - Wed Apr  7 22:39:25 PDT 2010
After getting rid of encode(utf-8), the number of uncleaned files drops from
67.6k to 4.1k.
=-=757 - Thu Apr  8 22:55:27 PDT 2010
So far it seems feedparser emits utf-8, and beautifulSoup returns utf-8. So
our problem is to simply not screw it up with the utf-8 that we are given.

htmlclean.py should now only ever read or write utf-8 by default. Let's test
this.
=-=758 - Fri Apr  9 20:08:28 PDT 2010
Ok, this works. Surprising how close it already was.
=-=759 - Sat Apr 10 02:10:17 PDT 2010

Are we still seeing the error fixed in 747? Logging.
=-=762 - Sun Apr 11 03:57:10 PDT 2010

Better feedback for stations in random mode.
=-=763 - Mon Apr 12 16:00:12 PDT 2010

Incorporating comments from Daniel Gackle, Ben Silberman, and Tristan Kromer.
  'your channels' -> 'my channels', etc.
  deemphasize navigation. lighter headings, non-blue links.
  fixed buttons were distracting between two columns of scrolling text; move
  left navigation to the right, deemphasizing it further.
=-=764 - Tue Apr 13 16:06:58 PDT 2010
Layout fix for signup screen.
=-=765 - Tue Apr 13 16:32:57 PDT 2010
New button layout, with a thumb for downvoting and making upvotes less
stress-inducing.
Now update the algorithm to not over-interpret upvotes.
=-=767 - Tue Apr 13 19:12:55 PDT 2010
Star now moves to next story.
It also does this in the bookmark view, but that is perhaps a bad idea.
=-=770 - Tue Apr 13 23:36:07 PDT 2010
In the bookmark view unstarring/restarring doesn't move onward.
=-=771 - Tue Apr 13 23:41:08 PDT 2010
copywidget from http://github.com/mojombo/clippy
=-=772 - Wed Apr 14 03:14:08 PDT 2010
Signup pages were broken since yesterday. Fixed.
=-=775 - Wed Apr 14 14:00:41 PDT 2010
Signup page had stopped blocking scrolling for weeks. Fixed.
=-=776 - Wed Apr 14 14:47:59 PDT 2010
Stop forcing people to sign up after 8 votes. Messes up the funnel analytics,
but we'll get to that.
=-=777 - Wed Apr 14 16:49:54 PDT 2010
Signup flow tweaks.
=-=778 - Wed Apr 14 18:08:36 PDT 2010
Signup's downvote button to default UI.
=-=779 - Wed Apr 14 20:17:57 PDT 2010
Move back to next/save instead of arrows for default UI. Nah, move back.
We'll move to next/star/thumbsdown for signup as well.
=-=780 - Wed Apr 14 20:35:16 PDT 2010
Undone.
=-=781 - Wed Apr 14 20:36:24 PDT 2010
Standardize button layout for signup.
=-=782 - Wed Apr 14 20:46:30 PDT 2010
A/B Test cleanup.
=-=783 - Wed Apr 14 20:47:12 PDT 2010
Don't let signup flow run out of stories.
=-=784 - Wed Apr 14 20:51:20 PDT 2010
Star button wasn't working during signup.
And this approach won't work.
=-=785 - Wed Apr 14 21:08:44 PDT 2010
Done.
=-=786 - Wed Apr 14 21:12:55 PDT 2010
A couple of tweaks on production.
=-=787 - Wed Apr 14 21:29:32 PDT 2010
Right-nav layout tweaks.
=-=788 - Wed Apr 14 21:35:29 PDT 2010
Clearing temp users.
=-=789 - Wed Apr 14 21:38:51 PDT 2010

Email button - front-end. Brought back from 5am.
Do we really need this? Or am I just messing around with unnecessary features?
Build a simple version.
=-=790 - Wed Apr 14 22:18:15 PDT 2010
Back-end done!
=-=791 - Wed Apr 14 22:58:40 PDT 2010
Done configuring authsmtp according to instructions at:
  http://www.authsmtp.com/postfix
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
smtp_sasl_mechanism_filter = plain
relayhost = mail.authsmtp.com

Then run postmap and restart postfix.
=-=792 - Thu Apr 15 02:01:15 PDT 2010
Layout and email copy tweaks on production.
=-=793 - Thu Apr 15 02:23:11 PDT 2010

Funnel analytics should start working again now. But they need to be
interpreted differently. The old funnel is the new funnel with property
signup=false, and it can go on indefinitely.
The funnel with signup=true measures what stage people signup at.
=-=795 - Thu Apr 15 13:06:28 PDT 2010
Agh, I break the signup so easily.
=-=796 - Thu Apr 15 14:30:40 PDT 2010

Button for star as well. Buttons now consistently indicate navigation. So the
star on the bookmark page isn't a button.
=-=797 - Thu Apr 15 14:48:02 PDT 2010
Make the border one step darker on 0to255.com. afb7ff to 9ea8ff.
=-=798 - Thu Apr 15 14:50:29 PDT 2010
Darker border makes button seems larger. Compensate.
=-=799 - Thu Apr 15 14:52:15 PDT 2010

Email copy tweak. Still not very obvious who's sending the message.
Perhaps add to subject.
=-=801 - Thu Apr 15 15:07:44 PDT 2010
More minor email copy tweaks.
=-=803 - Thu Apr 15 15:21:43 PDT 2010

Srikanth's found a way to center the site in the browser but still have
absolutely positioned buttons that stay on-screen. How'd he do that?!
=-=806 - Thu Apr 15 21:53:23 PDT 2010
Modified his test.html to have the same structure as my current layout in
test2.html.
=-=807 - Thu Apr 15 21:59:57 PDT 2010
Cleanup in preparation of applying test.html; be more consistent in using ids
and classes. Couple of id/class css bugfixes (rwhistory, rwpost-body).
main.css now more readable.
=-=808 - Thu Apr 15 22:14:36 PDT 2010
Done!
=-=809 - Thu Apr 15 22:25:23 PDT 2010
Get rid of obsolete button helpers.
=-=810 - Thu Apr 15 22:32:20 PDT 2010
But now the buttons had stopped working. There were confusingly both a class
and an id called rwhistory. Fixed.
=-=811 - Thu Apr 15 22:58:02 PDT 2010
Fix bookmark view.
=-=812 - Thu Apr 15 23:01:53 PDT 2010
Fix signup view.
=-=813 - Thu Apr 15 23:32:58 PDT 2010
More css cleanup.
One remaining issue. Flash messages and the signup progress bar are too wide.
I need to put them within rwpost, not rwcontent.
=-=814 - Thu Apr 15 23:49:34 PDT 2010
Done, but now the function boundaries are seemingly in all the wrong places.
=-=815 - Fri Apr 16 09:08:39 PDT 2010
Code reorganized to apply flash properly. Still some rough edges in where the
function boundaries are, but I'm more confident it's at least correct.
=-=816 - Fri Apr 16 12:00:06 PDT 2010

Further design ideas from Srikanth. Put the buttons 'outside' the rest of the
layout. Visually separate various components and optionally make them pop with
drop shadows and very slight rounded corners.
=-=817 - Fri Apr 16 21:26:08 PDT 2010
Lining them up with readwarp layout.
=-=819 - Fri Apr 16 23:32:50 PDT 2010
Intermezzo. Insert seps and gutters into the readwarp layout.
=-=820 - Sat Apr 17 13:51:20 PDT 2010
Done lining up class names with readwarp layout.
=-=821 - Sat Apr 17 13:57:06 PDT 2010
Layout done. Remaining: drop-shadow and rounded corners.
=-=822 - Sat Apr 17 14:34:51 PDT 2010
Drop-shadows, rounded corners.
Lots of tweaks.
=-=824 - Sat Apr 17 16:09:48 PDT 2010
Drop shadow for the spinner.
=-=825 - Sat Apr 17 17:06:10 PDT 2010
CSS tweaks for IE. Still ugly in IE; margin-left for rwpost is being
misinterpreted.
=-=826 - Sat Apr 17 19:27:08 PDT 2010
Reduce the number of different font sizes. Everything is 14px by default; only
article title, next button and pagination links in history panel are
different.
=-=827 - Sat Apr 17 19:44:13 PDT 2010
Made title same size as the next button.
Move button bar below article header.
Added min-height to article box.
More cleanup.
=-=828 - Sat Apr 17 20:01:14 PDT 2010

Change the star to show that a user has bookmarks.
=-=829 - Sat Apr 17 21:58:05 PDT 2010

Tweaks to handle large images and short articles.
=-=832 - Sun Apr 18 12:34:16 PDT 2010

Bugfix: clicking on history was broken since patch 816 48 hours ago.
=-=833 - Sun Apr 18 12:36:11 PDT 2010

Ack, my daily emails were being silently dropped.
Scanning the logs I see I lost one piece of feedback from someone who logged
in today. Probably srikanth?
=-=834 - Sun Apr 18 13:52:44 PDT 2010
Start showing feedback in the screenlog.
=-=835 - Sun Apr 18 14:10:49 PDT 2010

Article layout. Start deleting crap from the cleaned html like in readability
0.5. We're gradually going to bring in all of 0.5's heuristics.
=-=836 - Sun Apr 18 14:46:45 PDT 2010

Force width for *really* short articles.
=-=837 - Sun Apr 18 15:16:23 PDT 2010

Bugfix: signing up without going through the funnel had stopped working.
=-=842 - Sun Apr 18 22:23:19 PDT 2010

paulgraham.com updates.
=-=843 - Mon Apr 19 02:55:07 PDT 2010

Feedback link was in its own line. Fixed.
=-=845 - Mon Apr 19 12:12:58 PDT 2010

Beginnings of a new color palette.
=-=846 - Mon Apr 19 13:50:23 PDT 2010
Refactor CSS.
=-=847 - Mon Apr 19 14:00:47 PDT 2010
Background was too jarring; go back to the original. But we'll use the rest of
the palette for buttons.
=-=848 - Mon Apr 19 14:10:03 PDT 2010

IE tweak for the week.
=-=849 - Mon Apr 19 14:17:07 PDT 2010

Trying out new SVG buttons built with inkscape.
Some CSS cleanup.
Email form tweaks. Outline tries to match email icon.
=-=850 - Mon Apr 19 18:24:30 PDT 2010

Pushing new cleaner to production. Attempts to test it have been mixed; I see
places with totally different text. Outdated urls?
=-=851 - Mon Apr 19 03:49:46 PDT 2010

thumbs down button: Remove dark border.
=-=852 - Mon Apr 19 18:34:00 PDT 2010

I hadn't really pushed the new htmlclean to production until now. Here's why
readability can't delete id's and classes: because they may contain
display:none. Similarly, don't delete styles if they contain display:none.
=-=853 - Mon Apr 19 18:51:25 PDT 2010

Yet another set of buttons. Color theme now losing last vestiges of grey.
=-=854 - Mon Apr 19 19:38:31 PDT 2010
Grey gone.
=-=855 - Mon Apr 19 19:52:23 PDT 2010

More spacing for next/prev.
=-=856 - Mon Apr 19 22:39:42 PDT 2010
Bugfix: clicking on bookmark links wasn't working.
=-=857 - Mon Apr 19 22:44:21 PDT 2010
The problem went deeper. 5 whys: give each panel on the screen a single
entrypoint function that knows what to do when the station is bookmarks.
=-=858 - Mon Apr 19 22:52:53 PDT 2010

Email form tweaks.
=-=860 - Tue Apr 20 01:48:30 PDT 2010

Eliminate all the complexity in deciding what to show on signup. Just get one
selection algorithm right, make it work for signup as well.
But I never see feeds repeat pre-signup. Bug?
=-=861 - Tue Apr 20 02:30:46 PDT 2010
Ah, I missed the key piece.
=-=863 - Tue Apr 20 02:39:04 PDT 2010

All these weeks init-preferred was never actually running. Now I've forced it
on it promptly had a bug.
=-=864 - Tue Apr 20 03:11:07 PDT 2010

Another bug: people's preferred feeds haven't properly loaded into their
channels. Argh.. I changed how this worked at some point but didn't update the
data.
Just updating my feeds for now to see if that breaks anything.
Loading subsets of preferred feeds into a station is a mess. What if I delete
a group? We're going to redo this next, go through a group selection before a
feed selection.
=-=865 - Tue Apr 20 03:26:44 PDT 2010

3-state icons from Srikanth.
=-=866 - Tue Apr 20 13:43:51 PDT 2010
=-=867 - Tue Apr 20 14:32:55 PDT 2010
New buttons incorporated.
=-=868 - Tue Apr 20 16:10:20 PDT 2010
Tooltips.
=-=871 - Tue Apr 20 21:41:30 PDT 2010
More button tweaks from srikanth.
=-=872 - Wed Apr 21 11:21:52 PDT 2010

Yet another bookmarking bug that nobody noticed. Bookmarks and channels are
def on their way out.
=-=878 - Sat Apr 24 05:26:58 PDT 2010

Srikanth's new logo.
=-=880 - Sat Apr 24 14:16:50 PDT 2010

Trying to get back into arc hacking with a new kwarg macro.
=-=883 - Sat Apr 24 19:50:55 PDT 2010
Yet another kwarg macro. Allow random symbols to be inserted into a call for
documentation purposes. They can be misleading, though.
=-=884 - Sat Apr 24 20:16:08 PDT 2010
A very strict checker for mandatory keyword args. Now them to be optional, but
not out of order.
=-=885 - Mon Apr 26 02:13:00 PDT 2010
A less rigid checker. It still won't check that you have the right number of
args, nor that you give a value to each kwarg. But it will enforce ordering.
=-=886 - Mon Apr 26 02:53:20 PDT 2010

Turns out async-exec needs to be a macro anyway so I can't use defc.
Once we get past the need for kwargs, async-exec is an easy macro to write.
Key features:
  the body is gated by a cache variable. If the cache is set we don't perform
  the expensive asynchronous body.
  if the body takes too long we give up and return nil.
  we don't wait longer than we need to. If the body returns we yield the
  result immediately.

Here's also an example that uses async-exec that queries twitter for the
number of friends for a user, but returns nil if it takes too long.
=-=887 - Mon Apr 26 03:29:05 PDT 2010

pk45059 is back again, for two consecutive days this time.
New feedback just 3-4 hours ago: whats the difference between "next" and
"skip"? Response in flash.
=-=888 - Mon Apr 26 04:08:12 PDT 2010
=-=889 - Mon Apr 26 04:24:10 PDT 2010
Try to minimize how long he has to stare at that large flash by immediately
pinging me.
=-=890 - Mon Apr 26 04:28:34 PDT 2010

Reduce the number of corners catching the eye as Mike Albers suggested.
=-=891 - Wed Apr 28 17:21:13 PDT 2010

New branch: working on a redo in node.js. Several pieces are now working: haml
rendering, db using riak, crawling twitter in non-blocking fashion.
But it's not clear node.js has threads.
And riak seems like an overly low-level interface. I'd have to build up
primitives to maintain lists of keys in each bucket.
=-=892 - Thu Apr 29 11:52:05 PDT 2010
Separate js modules.
=-=893 - Thu Apr 29 12:16:48 PDT 2010
Import http://github.com/akkartik/node_chat
Next: convert www/static/index.html to the readwarp page layout with the chat
on the right. Perhaps in haml.
=-=894 - Thu Apr 29 12:56:42 PDT 2010
This thread by jerf convinced me to not do *everything* in node.js
  http://news.ycombinator.com/item?id=1304599
End of branch. After comments from HN:
  http://news.ycombinator.com/item?id=1306313
it becomes apparent I need to make smarter recommendations for new users.
That's the priority. And it's on the way of real-time updates and greater
engagement as well. But that's later.
=-=897 - Fri Apr 30 20:34:55 PDT 2010

Kent Beck: Learn, Measure, Build
  http://www.justin.tv/startuplessonslearned/b/262656520
So let's start figuring out how to change the signup flow by first getting the
measurements right. The mixpanel funnel's been broken for weeks, unable to
detect signups. Tim at Mixpanel suggests using superproperties. Let's see.
=-=899 - Sun May  2 11:12:07 PDT 2010
Daily email: start summarizing voting stats.
=-=900 - Sun May  2 15:29:55 PDT 2010

Start preparing the back-end for more extensive crawling. First step: GC docs.
First sub-step: stop adding to docs, figure out how to render GC'd docs.
=-=901 - Mon May  3 19:09:20 PDT 2010
readwarp can now handle docs absent in urls/. Key metadata is saved to
old-docs*, and other stuff is errsafe'd to ensure it's off the critical path.
Hopefully new fields won't cause errors with absent docs; I've overloaded
check-doc to return nil by default rather than raise error.

I'm going to migrate existing docs. After that, old-docs* will include any
doc that gets shown.
Eventually I'll need to run a 'copying GC' pass to eliminate docs only shown
to non-loggedin users. Should be simple to build when needed.
=-=902 - Mon May  3 20:42:11 PDT 2010
Migration done. But I can't just use a queue in the feed-docs rhash. I need a
data structure I can iterate through.
Let's just build a doubly linked list.
=-=904 - Tue May  4 03:17:20 PDT 2010
Add length field to dlist.
=-=906 - Tue May  4 10:10:41 PDT 2010
New policy for persistent hashes: fixedq. Pops elems when it grows too big,
and applies delete function to them as they are popped.
=-=908 - Tue May  4 23:13:30 PDT 2010

Center-align logo like malbers suggested.
=-=909 - Tue May  4 15:35:42 PDT 2010

Make clicking on history not delete elems. A small patch, but there's almost
certainly a bug here because of how many places it's touching.

I'm starting to realize how much overhead is caused by css ids. Minimize.
=-=910 - Wed May  5 12:15:03 PDT 2010

Transparent persistence for dlists now works. But one test fails because arc
doesn't know how to compare dlists.
I think we need to add generics to arc now.
=-=912 - Wed May  5 12:54:00 PDT 2010
iso now an extensible generic function. Tests pass. As a bonus, we're able to
revert the system definition of iso (just def -> defgeneric) and extend it for
tables in 'user space'.
=-=913 - Wed May  5 22:53:03 PDT 2010
Playing with genericizing serialize/unserialize.
I can't just use the pickled representation to serialize tables or dlists,
because there's no way to detect that they're not lists when de-serializing.
The new version has several problems:
  nested structures aren't properly serialized
  since alists are now annotated I need to migrate data. But it eliminates the
  problem of special-casing nil to translate to a table.
=-=914 - Wed May  5 23:15:01 PDT 2010
Really quit when encountering a corrupted snapshot.
=-=915 - Wed May  5 23:25:46 PDT 2010
Time to drop a stake in the ground. Where we are right now:
- serialize table is correct. It can handle nested serializables.
- unserialize is still the old version. We can't use defgeneric for that.
- pickle is broken because it isn't recursive. defmethods and pickles must
  always be recursive to handle nested data structures.
=-=917 - Thu May  6 09:02:26 PDT 2010
Ah, let's just make it a convention to pickle data structures using the
serialize generic. This can remain in userspace, or we could later have
arc.arc do special things with the serialize generic.

serialize dlist is now correct. Unserialize remains.
=-=918 - Thu May  6 09:11:07 PDT 2010
Unserialize built. I'm still using the old unserialize inside
read-nested-table. Time to migrate data.
=-=919 - Thu May  6 10:08:22 PDT 2010
Ok, I've tested the next commit and verified the migration, but I can't commit
yet because I need to migrate production at this point. Steps on production:
  a) (quit), wait for restart
  b) (migrate), wait for restart
At this point the server should be running as usual, but with one caveat. If
it goes down before the next commit it won't be able to read its snapshots.
=-=920 - Thu May  6 10:50:08 PDT 2010
And here's the final patch. All tests now pass. Server can read its snapshots
again. Steps:
  wait for b) above
  push from client
Thu May  6 11:03:30 PDT 2010
Heh, murphy's law: server crashed during restart b. Fortunately nothing was
being saved yet or we'd have to redo the process. Lesson: wait for feeds to
finish loading before typing in (migrate).
Thu May  6 11:09:31 PDT 2010
Hmm, I miscalculated. Server is down after step b. Push.
=-=921 - Thu May  6 10:59:53 PDT 2010

Finally, garbage collecting for feed-docs. Steps on production after pushing:
  a) l!index
  b) (migrate)
  c) (quit), wait for restart
=-=922 - Thu May  6 14:44:31 PDT 2010
Didn't take into account that files are coming in between a) and b) above.
Should have killed scans first.
=-=923 - Thu May  6 14:48:19 PDT 2010

No point relying on pickle in unserialize. When we run into it we hang. Just
get rid of it.
=-=924 - Thu May  6 14:54:08 PDT 2010

Whoa, I turn on GC and browsing is immediately slower. Disable.
Perhaps I should have an external script do this, connected through a fifo.
=-=926 - Thu May  6 15:00:02 PDT 2010

Getting rid of bookmarks.
=-=928 - Thu May  6 15:52:27 PDT 2010
get rid of save from class names: like->next, save->like.
=-=929 - Thu May  6 15:55:09 PDT 2010

test=1 in mixpanel calls to try to get real-time feedback. Still not working.
Moving right along..
=-=930 - Thu May  6 16:37:32 PDT 2010

Let's try adding a gc process connected through yet another fifo.
=-=931 - Thu May  6 17:01:13 PDT 2010
Done and on production.
=-=932 - Thu May  6 17:24:12 PDT 2010
Now pruning urls/ on production.
=-=933 - Thu May  6 19:08:08 PDT 2010
Ack, I can't be running doc-feed willy-nilly now that it has side-effects.
Temporary fix; let's think about the right organization here.
=-=934 - Thu May  6 19:29:21 PDT 2010

Button reorg. Thumbs-up for like, give it the dark color, move it to the top.
=-=936 - Thu May  6 22:56:20 PDT 2010

Get rid of gc thread. Still running on production. We can't push until it's
done.
=-=938 - Thu May  6 23:09:38 PDT 2010

Move email button to article title.
=-=939 - Thu May  6 23:19:07 PDT 2010
History panel in pre-signup flow as well.
=-=940 - Thu May  6 23:49:44 PDT 2010

Bugfix: sometimes was unnecessarily picking stories.
=-=941 - Thu May  6 23:51:33 PDT 2010

Bugfixes on production after getting done with GC. On dev I didn't test with a
live data pipeline.
Also a typo that was showing the non-signedup view even to logged in users.
=-=942 - Fri May  7 12:47:36 PDT 2010

Setup a new baseline for performance tests. Currently we can handle 10
concurrents with 50% at 8.9s, but 20 concurrents is too much to handle.

And let's make this easier. We still have to pick a new user and sname for the
ab commandline everytime, but at least we don't have to modify the code to
force a fresh doc to be selected everytime.
=-=943 - Fri May  7 20:56:37 PDT 2010

Rampi's suggestion: a tagline in emails.
=-=944 - Sun May  9 00:31:03 PDT 2010

One more mixpanel configuration - and I see real-time updates on my test
server!
=-=945 - Mon May 10 10:10:00 PDT 2010
But signup property is still never set. Let's enable real-time updates on
production as well so the mixpanel guys can try it out.
=-=946 - Mon May 10 10:51:09 PDT 2010

When I got rid of showlists I stopped showing something from the namesake feed
when a new channel is created. Bring that back.
=-=947 - Mon May 10 15:57:16 PDT 2010

Stop trying to htmlclean webcomics; it's a fools mission. Just take the
friggin rss desc and hope it has the img.
=-=949 - Mon May 10 19:33:25 PDT 2010
A new data structure for feeds to not show during signup.
=-=950 - Mon May 10 20:01:42 PDT 2010
Stop showing poorly-cleaned feeds during signup.

I could simplify choose-feed using choose-from, but I lose the logging of
where each feed is coming from.
=-=951 - Tue May 11 11:03:32 PDT 2010
Ok, done simplifying and some reorg.
=-=952 - Tue May 11 11:27:59 PDT 2010

Tweaking the signup flow: don't show niche topics until users explicitly ask
for them.
=-=954 - Tue May 11 11:54:47 PDT 2010

Update frontpage copy, get rid of useless progress bar, and of the
much-villified prompts.
=-=955 - Tue May 11 14:46:26 PDT 2010

Are people not reading on readwarp because they see an old article? Expire
current article after 5 minutes.
=-=956 - Tue May 11 15:26:20 PDT 2010
Persistence for transient values. Turns out we can serialize them as is, but
anyway we've made our own serialization.
Turns out transient values play well with the old values, but migrating
ensures that users will now always see fresh stories.
=-=957 - Tue May 11 15:59:26 PDT 2010

Bugfix: always should allow for findg to return nil (timeout after n tries).
Rename: most-recent -> newest. That frees up recent to take on a more precise
meaning.
=-=958 - Tue May 11 17:11:06 PDT 2010

Prefer feeds updated in the last day. I'm not going to bother migrating data
right now. Just push to production, test that it works fine, and watch
recent-feeds* get populated.
=-=959 - Tue May 11 17:54:29 PDT 2010

crawler was churning out exceptions for the last 2 days trying to recrawl
deleted docs. Hopefully it wasn't doing any damage.
In debugging this I clobbered my url_map and had to restore from the laptop,
perhaps yday's version. Let's ensure that doesn't happen again.
=-=960 - Tue May 11 18:49:48 PDT 2010
Don't keep preferring recent feeds after the recent docs have been read.
This may affect performance.
=-=961 - Tue May 11 19:26:05 PDT 2010
Hmm, turns out I don't need a sense of temperature yet just to be smart about
pre- vs post-signup users.
=-=962 - Tue May 11 20:18:24 PDT 2010

Crawler: demarcate runs in log file.
=-=963 - Wed May 12 10:01:02 PDT 2010
A long-standing bug: crawl new stories in chronological order.
=-=964 - Wed May 12 10:01:30 PDT 2010

Instantly pause the data pipeline if /tmp/pause_crawl exists.
=-=965 - Wed May 12 10:02:55 PDT 2010

Pause the data pipeline before copying data to a test box.
=-=966 - Wed May 12 10:12:01 PDT 2010

Blacklists should not be permanent. To enable this I'm going to migrate
my preferred/unpreferred backoff structures into a single prefrange type, with
a start and an end time. Every user gets a personal clock that ticks with
every story shown. The prefrange for a story or group demarcates how long it
is to be preferred/unpreferred before it becomes neutral again. The interval
between start and end is the 'preferred range'. Before start it is
unpreferred, and after end it is neutral.

Hmm, you don't want the prefrange to ever go directly from unpreferred to
preferred just because the clock ticked. So unpreferring should always create
a 0-size prefrange. Is there a better representation to more structurally
encode this invariant?
=-=968 - Wed May 12 13:39:55 PDT 2010

Bugfix: spotted error in signup-doc-panel. Because I'm GC'ing temporary users?
=-=970 - Wed May 12 16:04:56 PDT 2010

New op: show me something instantly from this site.
=-=971 - Wed May 12 17:48:55 PDT 2010

Back to changing the preferred/unpreferred data structure to prefranges. I've
done the data migration* and updates on votes, and the site actually seems to
work. The new data structures are not being used, and selection is still from
st!preferred rather than st!sites. But st!groups is still a table with groups
in the keys, so things just work.

* - The data migration should be idempotent in that it can be run repeatedly
without crapping all over itself.
=-=972 - Thu May 13 10:00:14 PDT 2010

Bugfix: random-station feedback was broken. This is going to go away anyway.
=-=973 - Thu May 13 10:26:18 PDT 2010

Still having trouble with the patch to use st!sites and st!groups in
selections. To ease our lives, let's stop providing the ability to import
feeds manually. I need to wean myself off that crutch.
Also stripping out stations from UI.

Tests are now seriously broken.
=-=974 - Thu May 13 10:51:42 PDT 2010
Selection works now. Time for a performance test.
The way things stand right now, people will almost never see programming
stories by default.
Next step: after a few votes introduce the magic box during signup.
=-=975 - Thu May 13 11:50:56 PDT 2010

Perf testing is still too fucking laborious. Let's fix this.
=-=976 - Thu May 13 12:03:40 PDT 2010

First eradicate redundant station args.
=-=977 - Thu May 13 12:43:14 PDT 2010

Ok, perf testing shows we're able to handle 50 concurrents on localhost
without trouble.
That's without the data pipeline, but that hasn't changed today. So hopefully
we're good.

Temporarily need to disable wiping userinfo*.nil during migration, otherwise
the newly designated test user nil is never in the right format. Now I can run
a request, get an error, run migrate to get it in the right format, then run
the perf test.
=-=978 - Thu May 13 12:57:01 PDT 2010

Finally commit the layout for magic box.
How should same site work?
  If you typed in something recently it should show you stuff from one of the
  feeds of that query.
  If you didn't type in anything it should stay within the current feed.
  If there's nothing left to show it should give a message.
=-=980 - Thu May 13 13:41:57 PDT 2010
Implemented. Works well for queries like cnn and bbc, but fails miserably for
queries like technology. What to do?
=-=981 - Thu May 13 14:18:56 PDT 2010
Ok, if they want to rerun a query they can just click on it. Let same site
mean literally same site.
And show flash when out of stories in that site.
Hmm, perhaps I should then fall back on showing from the query.
=-=982 - Thu May 13 14:25:06 PDT 2010
Done. Working great.
Ok, now let's fix the onclick for the list of queries.
=-=983 - Thu May 13 14:31:12 PDT 2010
Ok, clicking on links works.
If a query yields nothing, say so.
=-=984 - Thu May 13 14:44:09 PDT 2010
Layout tweaks; make the magic box look like a subtly bulleted list.
=-=985 - Thu May 13 15:00:45 PDT 2010
Ok, magicbox input works too. Some duplication because I can't figure out how
to trigger the onsubmit handler through javascript.
=-=986 - Thu May 13 15:32:14 PDT 2010

Bugfix.
=-=987 - Thu May 13 15:37:40 PDT 2010

Rebecca mostly browsed within specific channels. Create a 'similar sites'
button so she can keep doing that.
But now she can't vote on stories easily. Browsing within a channel is
implicitly an upvote..
=-=988 - Thu May 13 16:11:31 PDT 2010

Keep more stories per site on hand.
=-=989 - Thu May 13 16:14:22 PDT 2010
